<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Logi Assembly Tree v20 - Projects</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      flex-wrap: wrap;
      position: relative;
      z-index: 100;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(90deg, #00d9ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header select {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      min-width: 120px;
    }

    .header label {
      font-size: 11px;
      color: #8892b0;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255,255,255,0.08);
      padding: 4px 10px;
      border-radius: 6px;
    }

    .header-btn {
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #3498db;
      color: white;
      transition: all 0.2s;
    }

    .header-btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }

    .header-btn.save-btn {
      background: #27ae60;
    }

    .header-btn.save-btn:hover {
      background: #1e8449;
    }

    .header-btn.undo-btn {
      background: #f39c12;
    }

    .header-btn.undo-btn:hover {
      background: #d68910;
    }

    .header-btn.undo-btn:disabled {
      background: #7f8c8d;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .header-btn.back-btn {
      background: #34495e;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .header-btn.back-btn:hover {
      background: #2c3e50;
    }

    .admin-only {
      display: none;
    }

    .admin-only.visible {
      display: flex;
    }

    .admin-btn {
      background: #9b59b6;
    }

    .admin-btn:hover {
      background: #8e44ad;
    }

    .login-btn {
      background: #e74c3c;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .login-btn:hover {
      background: #c0392b;
    }

    .user-badge {
      background: rgba(39, 174, 96, 0.3);
      color: #27ae60;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-text {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .status-text.loading { color: #f39c12; }
    .status-text.error { color: #e74c3c; }
    .status-text.success { color: #27ae60; }

    .db-indicator {
      background: rgba(39, 174, 96, 0.2);
      color: #27ae60;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .db-indicator.disconnected {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }

    .db-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #27ae60;
      animation: pulse 2s infinite;
    }

    .db-indicator.disconnected .db-dot {
      background: #e74c3c;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Dropdown */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-btn {
      background: #16a085;
    }

    .dropdown-btn:hover {
      background: #138d75;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      min-width: 160px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      border-radius: 6px;
      z-index: 1000;
      overflow: hidden;
      margin-top: 4px;
    }

    .dropdown-content.show {
      display: block;
    }

    .dropdown-content a {
      color: #333;
      padding: 10px 16px;
      text-decoration: none;
      display: block;
      font-size: 12px;
      transition: background 0.2s;
    }

    .dropdown-content a:hover {
      background: #f0f0f0;
    }

    /* ============================================ */
    /* HOME PAGE - PROJECT CARDS */
    /* ============================================ */
    .home-page {
      display: none;
      min-height: calc(100vh - 50px);
      padding: 30px;
      overflow-y: auto;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }

    .home-page.show {
      display: block;
    }

    .home-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .home-header h2 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .home-header p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .projects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .project-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
    }

    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    .project-card.hidden-project {
      opacity: 0.6;
      border: 2px dashed #bdc3c7;
    }

    .project-card-color-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
    }

    .project-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 12px;
    }

    .project-card-icon {
      font-size: 40px;
      line-height: 1;
    }

    .project-card-title {
      flex: 1;
    }

    .project-card-title h3 {
      font-size: 18px;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .project-card-title .assembly-count {
      font-size: 12px;
      color: #95a5a6;
    }

    .project-card-description {
      font-size: 13px;
      color: #7f8c8d;
      line-height: 1.5;
      margin-bottom: 15px;
      min-height: 40px;
    }

    .project-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 12px;
      border-top: 1px solid #ecf0f1;
    }

    .project-card-actions {
      display: flex;
      gap: 8px;
    }

    .project-card-actions button {
      padding: 6px 10px;
      font-size: 11px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .project-edit-btn {
      background: #3498db;
      color: white;
    }

    .project-edit-btn:hover {
      background: #2980b9;
    }

    .project-delete-btn {
      background: #e74c3c;
      color: white;
    }

    .project-delete-btn:hover {
      background: #c0392b;
    }

    /* Visibility Toggle */
    .visibility-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #7f8c8d;
    }

    .visibility-toggle input[type="checkbox"] {
      display: none;
    }

    .visibility-toggle label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toggle-switch {
      width: 36px;
      height: 20px;
      background: #bdc3c7;
      border-radius: 10px;
      position: relative;
      transition: background 0.3s;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }

    .visibility-toggle input:checked + label .toggle-switch {
      background: #27ae60;
    }

    .visibility-toggle input:checked + label .toggle-switch::after {
      transform: translateX(16px);
    }

    /* New Project Card (Add button) */
    .project-card.add-card {
      border: 2px dashed #bdc3c7;
      background: rgba(255,255,255,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: #95a5a6;
    }

    .project-card.add-card:hover {
      border-color: #3498db;
      color: #3498db;
      background: rgba(52, 152, 219, 0.05);
    }

    .project-card.add-card .add-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .project-card.add-card span {
      font-size: 14px;
      font-weight: 500;
    }

    /* ============================================ */
    /* ASSEMBLIES PAGE */
    /* ============================================ */
    .assemblies-page {
      display: none;
      min-height: calc(100vh - 50px);
      padding: 30px;
      overflow-y: auto;
    }

    .assemblies-page.show {
      display: block;
    }

    .assemblies-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
    }

    .assemblies-header .project-icon {
      font-size: 50px;
    }

    .assemblies-header-info h2 {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .assemblies-header-info p {
      font-size: 13px;
      color: #7f8c8d;
    }

    .assemblies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 15px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .assembly-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid;
    }

    .assembly-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .assembly-card.hidden-assembly {
      opacity: 0.6;
      border-style: dashed;
    }

    .assembly-card h4 {
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .assembly-card .node-count {
      font-size: 11px;
      color: #95a5a6;
    }

    .assembly-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #ecf0f1;
    }

    .assembly-card.add-card {
      border: 2px dashed #bdc3c7;
      background: rgba(255,255,255,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      color: #95a5a6;
      border-left: 2px dashed #bdc3c7;
    }

    .assembly-card.add-card:hover {
      border-color: #3498db;
      color: #3498db;
    }

    /* ============================================ */
    /* TREE VIEW PAGE */
    /* ============================================ */
    .tree-page {
      display: none;
    }

    .tree-page.show {
      display: block;
    }

    /* Legend */
    .legend {
      background: white;
      padding: 8px 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      border-bottom: 1px solid #e0e0e0;
      flex-wrap: wrap;
      font-size: 10px;
    }

    .legend-section {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .legend-title {
      font-weight: 600;
      color: #333;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #666;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .legend-divider {
      width: 1px;
      height: 20px;
      background: #ddd;
    }

    /* Main container */
    .main-container {
      display: flex;
      height: calc(100vh - 90px);
    }

    .tree-container {
      flex: 1;
      overflow: auto;
      background: #fafafa;
      position: relative;
      transition: background 0.3s;
    }

    svg {
      display: block;
    }

    /* Nodes */
    .node {
      cursor: grab;
    }

    .node:active {
      cursor: grabbing;
    }

    .node.selected .node-shape {
      filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.8));
    }

    .node.locked .node-shape {
      stroke-width: 3px !important;
    }

    .node.locked::after {
      content: 'üîí';
    }

    .lock-indicator {
      font-size: 8px;
      pointer-events: none;
    }

    .node.drop-target .node-shape {
      filter: drop-shadow(0 0 12px rgba(39, 174, 96, 0.9)) !important;
    }

    .node.child-highlight .node-shape {
      filter: drop-shadow(0 0 6px rgba(155, 89, 182, 0.7));
    }

    .node.dragging-children .node-shape {
      filter: drop-shadow(0 0 10px rgba(155, 89, 182, 0.9));
    }

    .node-shape {
      transition: filter 0.2s;
    }

    .node:hover .node-shape {
      filter: brightness(0.95);
    }

    .node-label {
      pointer-events: none;
      font-weight: 500;
    }

    .node-pn {
      pointer-events: none;
      fill: #666;
      font-style: italic;
    }

    .sequence-badge {
      font-size: 11px;
      font-weight: bold;
      fill: #e74c3c;
      pointer-events: none;
    }

    .toggle-icon {
      font-weight: bold;
      font-size: 10px;
      fill: #333;
      pointer-events: none;
    }

    .link {
      fill: none !important;
      stroke-linecap: round;
      stroke-linejoin: round;
      cursor: pointer;
    }

    .link:hover {
      stroke-width: 3px !important;
    }

    .link.selected {
      stroke-width: 3px !important;
      filter: drop-shadow(0 0 4px rgba(52, 152, 219, 0.8));
    }

    .link-label {
      font-size: 8px;
      pointer-events: none;
      font-weight: 600;
    }

    .link-label-bg {
      fill: white;
      opacity: 0.95;
    }

    .status-indicator {
      stroke-width: 2px;
    }

    .collapse-indicator {
      fill: #ffffff;
      stroke: #333;
      stroke-width: 1.5px;
      cursor: pointer;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }

    .collapse-indicator:hover {
      fill: #e8e8e8;
    }

    .toggle-icon {
      font-size: 10px;
      font-weight: bold;
      fill: #333;
      pointer-events: none;
      user-select: none;
    }

    .multi-parent-indicator {
      fill: none;
      stroke-width: 2px;
    }

    /* Context Menu */
    .context-menu {
      display: none;
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      min-width: 180px;
      z-index: 1000;
      overflow: hidden;
      animation: menuFadeIn 0.15s ease;
    }

    @keyframes menuFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .context-menu.show {
      display: block;
    }

    .context-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #333;
      transition: background 0.15s;
    }

    .context-menu-item:hover {
      background: #f5f5f5;
    }

    .context-menu-item.danger {
      color: #e74c3c;
    }

    .context-menu-item.danger:hover {
      background: #fef0f0;
    }

    .context-menu-divider {
      height: 1px;
      background: #eee;
      margin: 4px 0;
    }

    .context-menu-icon {
      font-size: 14px;
      width: 20px;
      text-align: center;
    }

    /* Side Panel */
    .side-panel {
      width: 0;
      background: white;
      border-left: 1px solid #e0e0e0;
      overflow: hidden;
      transition: width 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .side-panel.open {
      width: 320px;
    }

    .side-panel-header {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .side-panel-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .side-panel-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #666;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .side-panel-close:hover {
      background: #eee;
    }

    .side-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      border: 1px solid #ddd;
      border-radius: 6px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: flex;
      gap: 10px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .side-panel-footer {
      padding: 15px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-secondary {
      background: #ecf0f1;
      color: #333;
    }

    .btn-secondary:hover {
      background: #ddd;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-block {
      width: 100%;
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 12px 20px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: toastIn 0.3s ease;
      max-width: 350px;
    }

    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    .toast.warning { background: #f39c12; }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1500;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: modalIn 0.2s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Emoji Picker */
    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .emoji-picker button {
      font-size: 24px;
      padding: 8px;
      border: none;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .emoji-picker button:hover {
      background: #e8e8e8;
      transform: scale(1.1);
    }

    .emoji-picker button.selected {
      background: #3498db;
      box-shadow: 0 0 0 2px #3498db;
    }

    /* Color Picker */
    .color-picker {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .color-picker button {
      width: 40px;
      height: 40px;
      border: 3px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .color-picker button:hover {
      transform: scale(1.1);
    }

    .color-picker button.selected {
      border-color: #2c3e50;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #2c3e50;
    }

    /* Icon preview in form */
    .icon-preview {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon-preview-emoji {
      font-size: 40px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-preview-emoji:hover {
      background: #e8e8e8;
    }

    /* Color preview swatch */
    .color-preview-swatch {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid #ddd;
    }

    .color-preview-swatch:hover {
      transform: scale(1.05);
    }

    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.show {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #eee;
      border-top-color: #3498db;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .side-panel.open {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        max-width: 320px;
        z-index: 200;
      }

      .projects-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>‚öôÔ∏è Logi Assembly v20</h1>
  
  <!-- Back button (shown when not on home page) -->
  <button class="header-btn back-btn" id="backBtn" style="display:none;" onclick="navigateBack()">
    ‚Üê Back
  </button>
  
  <!-- Breadcrumb -->
  <div id="breadcrumb" class="control-group" style="display:none;">
    <span id="breadcrumbText" style="font-size:12px;color:#8892b0;"></span>
  </div>
  
  <!-- Tree-specific controls (only visible in tree view) -->
  <div id="treeControls" style="display:none;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <div class="control-group">
      <label>Level:</label>
      <select id="levelFilter">
        <option value="all">All</option>
        <option value="1">‚â§L1</option>
        <option value="2">‚â§L2</option>
        <option value="3">‚â§L3</option>
        <option value="4">‚â§L4</option>
        <option value="5">‚â§L5</option>
        <option value="6">‚â§L6</option>
        <option value="7">‚â§L7</option>
        <option value="8">‚â§L8</option>
      </select>
    </div>
    
    <div class="control-group">
      <label>Color:</label>
      <select id="colorMode">
        <option value="level">Level</option>
        <option value="group">Group</option>
        <option value="status">Status</option>
      </select>
    </div>
    
    <!-- Admin-only controls -->
    <div class="control-group admin-only" id="layoutControl">
      <label>Layout:</label>
      <select id="layoutMode">
        <option value="force">Force</option>
        <option value="radial">Radial (L3+)</option>
      </select>
    </div>
    
    <button class="header-btn admin-only" id="refreshBtn" onclick="refreshUnlockedNodes()">üîÑ</button>
    <button class="header-btn admin-only" id="expandBtn" onclick="expandAll()">‚ûï</button>
    <button class="header-btn admin-only" id="collapseBtn" onclick="collapseAll()">‚ûñ</button>
    <button class="header-btn undo-btn admin-only" id="undoBtn" onclick="undoPositions()" disabled>‚Ü©Ô∏è Undo</button>
    
    <div class="dropdown admin-only">
      <button class="header-btn dropdown-btn" style="background:#9b59b6;" onclick="toggleLockDropdown()">üîí Lock ‚ñº</button>
      <div class="dropdown-content" id="lockDropdown">
        <a href="#" onclick="lockAllVisibleNodes(); closeLockDropdown(); return false;">üîí Lock All Visible</a>
        <a href="#" onclick="unlockAllNodes(); closeLockDropdown(); return false;">üîì Unlock All</a>
      </div>
    </div>
    
    <button class="header-btn save-btn admin-only" id="saveBtn" onclick="saveAllPositions()">üíæ Save</button>
    
    <div class="dropdown">
      <button class="header-btn dropdown-btn" onclick="toggleExportDropdown()">üì§ Export ‚ñº</button>
      <div class="dropdown-content" id="exportDropdown">
        <a href="#" onclick="downloadPNG(); return false;">üì∑ Download PNG</a>
        <a href="#" onclick="downloadSVG(); return false;">üìê Download SVG</a>
      </div>
    </div>
  </div>
  
  <span id="statusIndicator" class="status-text"></span>
  
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
    <div id="dbIndicator" class="db-indicator">
      <span class="db-dot"></span>
      <span>Supabase</span>
    </div>
    
    <!-- Login/User area -->
    <div id="loginArea">
      <button class="header-btn login-btn" id="loginBtn" onclick="handleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:14px;height:14px;"> Sign In
      </button>
    </div>
    <div id="userBadge" class="user-badge" style="display:none;">
      <span id="userName"></span>
      <button class="header-btn" style="padding:2px 6px;font-size:9px;" onclick="handleLogout()">‚úï</button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- HOME PAGE - PROJECTS -->
<!-- ============================================ -->
<div class="home-page show" id="homePage">
  <div class="home-header">
    <h2>üìÅ My Projects</h2>
    <p>Select a project to view its assemblies</p>
  </div>
  <div class="projects-grid" id="projectsGrid">
    <!-- Project cards will be rendered here -->
  </div>
</div>

<!-- ============================================ -->
<!-- ASSEMBLIES PAGE -->
<!-- ============================================ -->
<div class="assemblies-page" id="assembliesPage">
  <div class="assemblies-header" id="assembliesHeader">
    <span class="project-icon" id="currentProjectIcon">üìÅ</span>
    <div class="assemblies-header-info">
      <h2 id="currentProjectName">Project Name</h2>
      <p id="currentProjectDesc">Project description</p>
    </div>
  </div>
  <div class="assemblies-grid" id="assembliesGrid">
    <!-- Assembly cards will be rendered here -->
  </div>
</div>

<!-- ============================================ -->
<!-- TREE VIEW PAGE -->
<!-- ============================================ -->
<div class="tree-page" id="treePage">
  <!-- Legend -->
  <div class="legend">
    <div class="legend-section">
      <span class="legend-title">Levels:</span>
      <div class="legend-item"><div class="legend-color" style="background:#e8e8e8;"></div>L1</div>
      <div class="legend-item"><div class="legend-color" style="background:#ffcdd2;"></div>L2</div>
      <div class="legend-item"><div class="legend-color" style="background:#ffe0b2;"></div>L3</div>
      <div class="legend-item"><div class="legend-color" style="background:#fff9c4;"></div>L4</div>
      <div class="legend-item"><div class="legend-color" style="background:#c8e6c9;"></div>L5</div>
      <div class="legend-item"><div class="legend-color" style="background:#b3e5fc;"></div>L6</div>
      <div class="legend-item"><div class="legend-color" style="background:#e1bee7;"></div>L7</div>
      <div class="legend-item"><div class="legend-color" style="background:#a5d6a7;"></div>L8</div>
    </div>
    
    <div class="legend-divider"></div>
    
    <div class="legend-section">
      <span class="legend-title">Status:</span>
      <div class="legend-item"><div class="legend-color" style="background:#27ae60;"></div>Done</div>
      <div class="legend-item"><div class="legend-color" style="background:#f1c40f;"></div>WIP</div>
      <div class="legend-item"><div class="legend-color" style="background:#e74c3c;"></div>Blocked</div>
      <div class="legend-item"><div class="legend-color" style="background:#9b59b6; border-style:dashed;"></div>Orphan</div>
    </div>
    
    <div class="legend-divider"></div>
    
    <div class="legend-section admin-only" id="legendTips">
      <span style="color:#666; font-size:9px;">üí° Shift+Drag = move with children | Drag orphan = reconnect | üîí = locked position</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="tree-container" id="treeContainer">
      <svg id="treeSvg"></svg>
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
      </div>
    </div>
    
    <!-- Side Panel for editing -->
    <div class="side-panel" id="sidePanel">
      <div class="side-panel-header">
        <span class="side-panel-title" id="panelTitle">Edit Node</span>
        <button class="side-panel-close" onclick="closeSidePanel()">√ó</button>
      </div>
      <div class="side-panel-content" id="panelContent">
        <!-- Dynamic content -->
      </div>
      <div class="side-panel-footer" id="panelFooter">
        <!-- Dynamic buttons -->
      </div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
  <!-- Dynamic content -->
</div>

<!-- Modal for confirmations -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Confirm</div>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer" id="modalFooter">
      <!-- Dynamic buttons -->
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ============================================================
// SUPABASE CONFIGURATION
// ============================================================
const SUPABASE_URL = 'https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';

// Create Supabase client
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ============================================================
// CONSTANTS
// ============================================================
const LEVEL_COLORS = [
  "#e8e8e8", "#ffcdd2", "#ffe0b2", "#fff9c4",
  "#c8e6c9", "#b3e5fc", "#e1bee7", "#a5d6a7"
];

const GROUP_COLORS = [
  "#78909c", "#42a5f5", "#ff7043", "#ec407a",
  "#ab47bc", "#26a69a", "#d4e157", "#ffa726"
];

const STATUS_COLORS = {
  'DONE': { fill: "#27ae60", stroke: "#1e8449", bg: "#d5f5e3" },
  'IN_PROGRESS': { fill: "#f1c40f", stroke: "#d4ac0d", bg: "#fef9e7" },
  'NOT_STARTED': { fill: "#bdc3c7", stroke: "#95a5a6", bg: "#f4f6f6" },
  'BLOCKED': { fill: "#e74c3c", stroke: "#c0392b", bg: "#fdedec" },
  'ON_HOLD': { fill: "#e67e22", stroke: "#d35400", bg: "#fdebd0" },
  'REVIEW': { fill: "#3498db", stroke: "#2980b9", bg: "#ebf5fb" }
};

const LEVEL_SHAPES = [
  "rectangle", "rounded_rectangle", "pentagon", "stadium",
  "parallelogram", "hexagon", "ellipse", "octagon"
];

const SEQUENCE_BADGES = ['‚ì™','‚ë†','‚ë°','‚ë¢','‚ë£','‚ë§','‚ë•','‚ë¶','‚ëß','‚ë®','‚ë©','‚ë™','‚ë´','‚ë¨','‚ë≠','‚ëÆ','‚ëØ','‚ë∞','‚ë±','‚ë≤','‚ë≥'];

const FASTENER_COLORS = {
  CBE: "#3498db", CBST: "#9b59b6", M: "#27ae60", MS: "#e67e22",
  PRESS: "#e74c3c", ORIGINAL: "#7f8c8d", OTHER: "#2c3e50"
};

const NODE_WIDTH_BASE = 120;
const NODE_WIDTH_MAX = 160;

// Standard project colors
const PROJECT_COLORS = [
  { name: 'Blue', value: '#3498db' },
  { name: 'Green', value: '#27ae60' },
  { name: 'Purple', value: '#9b59b6' },
  { name: 'Red', value: '#e74c3c' },
  { name: 'Orange', value: '#e67e22' },
  { name: 'Teal', value: '#16a085' },
  { name: 'Pink', value: '#e91e63' },
  { name: 'Yellow', value: '#f1c40f' },
  { name: 'Slate', value: '#607d8b' },
  { name: 'Brown', value: '#795548' },
  { name: 'Indigo', value: '#3f51b5' },
  { name: 'Cyan', value: '#00bcd4' }
];

// Project icon emojis
const PROJECT_EMOJIS = [
  'üìÅ', 'üîß', 'üëª', 'üöó', 'üì¶', '‚öôÔ∏è', 'üèóÔ∏è', 'üî©',
  'üõ†Ô∏è', 'üè≠', 'üìê', 'üî¨', 'üí°', 'üéØ', 'üöÄ', '‚≠ê',
  'üîã', 'üîå', 'üñ•Ô∏è', 'üì±', 'ü§ñ', 'üé®', 'üìä', 'üåü',
  'üè†', 'üè¢', 'üåç', '‚úàÔ∏è', 'üöÅ', 'üö¢', 'üöÇ', 'üé™'
];

// ============================================================
// ADMIN CONFIGURATION
// ============================================================
const ADMIN_EMAIL = 'mangaonkaraniket@gmail.com';
const GOOGLE_CLIENT_ID = '960816882472-b3qjf15ehvab7mcuvf8154tveoub4sic.apps.googleusercontent.com';

// ============================================================
// GLOBAL STATE
// ============================================================
// Navigation state
let currentPage = 'home'; // 'home', 'assemblies', 'tree'
let projects = [];
let currentProject = null;
let assemblies = [];
let currentAssemblyId = null;
let currentAssemblyName = '';

// Tree state
let nodes = [];
let links = [];
let simulation = null;
let collapsedNodes = new Set();
let selectedNode = null;
let selectedLink = null;
let currentColorMode = 'level';
let currentLevelFilter = 'all';
let currentLayoutMode = 'force';
let shiftKeyPressed = false;
let draggingOrphan = null;
let dropTarget = null;

// Admin and position control
let isAdmin = false;
let lockedNodes = new Set();
let positionHistory = [];
const MAX_UNDO_HISTORY = 20;

const RADIAL_RADIUS = 120;
const RADIAL_DEAD_ZONE = 60;

// ============================================================
// INITIALIZATION
// ============================================================
async function init() {
  console.log('Initializing Logi Assembly v20...');
  
  // Check Supabase connection
  try {
    const { data, error } = await db.from('logi_projects').select('count', { count: 'exact', head: true });
    if (error) throw error;
    document.getElementById('dbIndicator').classList.remove('disconnected');
  } catch (e) {
    console.error('Supabase connection error:', e);
    document.getElementById('dbIndicator').classList.add('disconnected');
  }
  
  // Check admin status
  checkAdminStatus();
  
  // Load projects
  await loadProjects();
  
  // Setup event listeners
  setupEventListeners();
}

// ============================================================
// ADMIN / LOGIN FUNCTIONS (Google Sign-In)
// ============================================================
let googleUser = null;

function initGoogleSignIn() {
  if (typeof google === 'undefined' || !google.accounts) {
    console.log('Google Sign-In not loaded yet, retrying...');
    setTimeout(initGoogleSignIn, 500);
    return;
  }
  
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleCallback,
    auto_select: true,
  });
  
  const savedEmail = localStorage.getItem('logi_admin_email');
  if (savedEmail === ADMIN_EMAIL) {
    google.accounts.id.prompt();
  }
}

function handleGoogleCallback(response) {
  const payload = decodeJwtPayload(response.credential);
  
  if (payload && payload.email) {
    googleUser = payload;
    
    if (payload.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
      isAdmin = true;
      localStorage.setItem('logi_admin_email', payload.email);
      showAdminUI(payload);
      showToast(`Welcome, ${payload.name || 'Admin'}!`, 'success');
    } else {
      isAdmin = false;
      showToast('Logged in as guest (view only)', 'info');
      showGuestUI(payload);
    }
    
    // Reload current page to show/hide admin controls
    if (currentPage === 'home') {
      renderProjects();
    } else if (currentPage === 'assemblies') {
      renderAssemblies();
    }
  }
}

function decodeJwtPayload(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  } catch (e) {
    console.error('Failed to decode JWT:', e);
    return null;
  }
}

function checkAdminStatus() {
  initGoogleSignIn();
}

function handleLogin() {
  if (typeof google === 'undefined' || !google.accounts) {
    showToast('Google Sign-In not loaded. Please refresh.', 'error');
    return;
  }
  
  google.accounts.id.prompt((notification) => {
    if (notification.isNotDisplayed()) {
      showGoogleButtonFallback();
    }
  });
}

function showGoogleButtonFallback() {
  showModal(
    'Sign In',
    '<div id="googleButtonContainer" style="display:flex;justify-content:center;padding:20px;"></div>',
    [{ label: 'Cancel', class: 'btn-secondary', action: hideModal }]
  );
  
  setTimeout(() => {
    const container = document.getElementById('googleButtonContainer');
    if (container && google.accounts.id) {
      google.accounts.id.renderButton(container, {
        theme: 'outline',
        size: 'large',
        text: 'signin_with',
      });
    }
  }, 100);
}

function handleLogout() {
  googleUser = null;
  isAdmin = false;
  localStorage.removeItem('logi_admin_email');
  
  document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('visible'));
  document.getElementById('userBadge').style.display = 'none';
  document.getElementById('loginArea').style.display = 'block';
  
  showToast('Logged out', 'success');
  
  // Reload current page
  if (currentPage === 'home') {
    renderProjects();
  } else if (currentPage === 'assemblies') {
    renderAssemblies();
  }
}

function showAdminUI(user) {
  document.querySelectorAll('.admin-only').forEach(el => el.classList.add('visible'));
  document.getElementById('loginArea').style.display = 'none';
  document.getElementById('userBadge').style.display = 'flex';
  document.getElementById('userName').textContent = user.name || user.email;
}

function showGuestUI(user) {
  document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('visible'));
  document.getElementById('loginArea').style.display = 'none';
  document.getElementById('userBadge').style.display = 'flex';
  document.getElementById('userName').textContent = (user.name || user.email) + ' (Guest)';
}

// ============================================================
// NAVIGATION
// ============================================================
function navigateTo(page) {
  currentPage = page;
  
  // Hide all pages
  document.getElementById('homePage').classList.remove('show');
  document.getElementById('assembliesPage').classList.remove('show');
  document.getElementById('treePage').classList.remove('show');
  document.getElementById('treeControls').style.display = 'none';
  document.getElementById('backBtn').style.display = 'none';
  document.getElementById('breadcrumb').style.display = 'none';
  
  // Show selected page
  if (page === 'home') {
    document.getElementById('homePage').classList.add('show');
    currentProject = null;
  } else if (page === 'assemblies') {
    document.getElementById('assembliesPage').classList.add('show');
    document.getElementById('backBtn').style.display = 'flex';
    document.getElementById('breadcrumb').style.display = 'flex';
    document.getElementById('breadcrumbText').textContent = currentProject?.name || 'Project';
    
    // Apply project color to background
    const color = currentProject?.color || '#3498db';
    document.getElementById('assembliesPage').style.background = `linear-gradient(135deg, ${hexToRgba(color, 0.05)} 0%, ${hexToRgba(color, 0.1)} 100%)`;
  } else if (page === 'tree') {
    document.getElementById('treePage').classList.add('show');
    document.getElementById('treeControls').style.display = 'flex';
    document.getElementById('backBtn').style.display = 'flex';
    document.getElementById('breadcrumb').style.display = 'flex';
    document.getElementById('breadcrumbText').textContent = `${currentProject?.name || 'Project'} / ${currentAssemblyName}`;
    
    // Apply project color as very light background tint
    const color = currentProject?.color || '#3498db';
    document.getElementById('treeContainer').style.background = `linear-gradient(135deg, ${hexToRgba(color, 0.03)} 0%, ${hexToRgba(color, 0.08)} 100%)`;
  }
}

function navigateBack() {
  if (currentPage === 'tree') {
    navigateTo('assemblies');
    renderAssemblies();
  } else if (currentPage === 'assemblies') {
    navigateTo('home');
  }
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// ============================================================
// PROJECT FUNCTIONS
// ============================================================
async function loadProjects() {
  setStatus('Loading projects...', 'loading');
  
  try {
    let query = db.from('logi_projects').select('*').order('name');
    
    // Guests only see visible projects
    if (!isAdmin) {
      query = query.eq('is_visible', true);
    }
    
    const { data, error } = await query;
    
    if (error) throw error;
    
    projects = data || [];
    renderProjects();
    setStatus('');
  } catch (e) {
    console.error('Error loading projects:', e);
    setStatus('Error loading projects', 'error');
    showToast('Failed to load projects', 'error');
  }
}

function renderProjects() {
  const grid = document.getElementById('projectsGrid');
  
  // Filter projects for guests
  const visibleProjects = isAdmin ? projects : projects.filter(p => p.is_visible);
  
  let html = '';
  
  // Render project cards
  for (const project of visibleProjects) {
    const isHidden = !project.is_visible;
    html += `
      <div class="project-card ${isHidden ? 'hidden-project' : ''}" onclick="openProject('${project.id}')">
        <div class="project-card-color-bar" style="background:${project.color || '#3498db'}"></div>
        <div class="project-card-header">
          <span class="project-card-icon">${project.icon || 'üìÅ'}</span>
          <div class="project-card-title">
            <h3>${escapeHtml(project.name)}</h3>
            <span class="assembly-count" id="projectCount_${project.id}">Loading...</span>
          </div>
        </div>
        <div class="project-card-description">${escapeHtml(project.description || 'No description')}</div>
        <div class="project-card-footer">
          ${isAdmin ? `
            <div class="visibility-toggle" onclick="event.stopPropagation()">
              <input type="checkbox" id="vis_${project.id}" ${project.is_visible ? 'checked' : ''} onchange="toggleProjectVisibility('${project.id}', this.checked)">
              <label for="vis_${project.id}">
                <span class="toggle-switch"></span>
                <span>${project.is_visible ? 'Visible' : 'Hidden'}</span>
              </label>
            </div>
            <div class="project-card-actions">
              <button class="project-edit-btn" onclick="event.stopPropagation(); editProject('${project.id}')">‚úèÔ∏è Edit</button>
              <button class="project-delete-btn" onclick="event.stopPropagation(); confirmDeleteProject('${project.id}')">üóëÔ∏è</button>
            </div>
          ` : '<span></span>'}
        </div>
      </div>
    `;
  }
  
  // Add "New Project" card for admin
  if (isAdmin) {
    html += `
      <div class="project-card add-card" onclick="createNewProject()">
        <span class="add-icon">‚ûï</span>
        <span>New Project</span>
      </div>
    `;
  }
  
  grid.innerHTML = html;
  
  // Load assembly counts for each project
  loadProjectCounts();
}

async function loadProjectCounts() {
  for (const project of projects) {
    try {
      let query = db.from('logi_assemblies').select('count', { count: 'exact', head: true }).eq('project_id', project.id);
      
      if (!isAdmin) {
        query = query.eq('is_visible', true);
      }
      
      const { count, error } = await query;
      
      if (!error) {
        const countEl = document.getElementById(`projectCount_${project.id}`);
        if (countEl) {
          countEl.textContent = `${count || 0} assembl${count === 1 ? 'y' : 'ies'}`;
        }
      }
    } catch (e) {
      console.error('Error loading count for project:', project.id, e);
    }
  }
}

async function openProject(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  
  currentProject = project;
  
  // Update header
  document.getElementById('currentProjectIcon').textContent = project.icon || 'üìÅ';
  document.getElementById('currentProjectName').textContent = project.name;
  document.getElementById('currentProjectDesc').textContent = project.description || 'No description';
  
  // Load assemblies for this project
  await loadAssemblies(projectId);
  
  // Navigate to assemblies page
  navigateTo('assemblies');
}

function createNewProject() {
  if (!isAdmin) return;
  
  // Pick a random color and emoji
  const randomColor = PROJECT_COLORS[Math.floor(Math.random() * PROJECT_COLORS.length)].value;
  const randomEmoji = PROJECT_EMOJIS[Math.floor(Math.random() * PROJECT_EMOJIS.length)];
  
  showProjectModal(null, {
    name: '',
    description: '',
    icon: randomEmoji,
    color: randomColor,
    is_visible: true
  });
}

function editProject(projectId) {
  if (!isAdmin) return;
  
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  
  showProjectModal(projectId, project);
}

function showProjectModal(projectId, data) {
  const isNew = !projectId;
  
  const emojiOptions = PROJECT_EMOJIS.map(emoji => 
    `<button type="button" class="${emoji === data.icon ? 'selected' : ''}" onclick="selectProjectEmoji('${emoji}')">${emoji}</button>`
  ).join('');
  
  const colorOptions = PROJECT_COLORS.map(c => 
    `<button type="button" style="background:${c.value}" class="${c.value === data.color ? 'selected' : ''}" onclick="selectProjectColor('${c.value}')" title="${c.name}"></button>`
  ).join('');
  
  const body = `
    <div class="form-group">
      <label class="form-label">Project Name</label>
      <input type="text" class="form-input" id="projectName" value="${escapeHtml(data.name || '')}" placeholder="Enter project name">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea class="form-textarea" id="projectDesc" placeholder="Enter description">${escapeHtml(data.description || '')}</textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <div class="icon-preview">
        <span class="icon-preview-emoji" id="selectedEmoji">${data.icon || 'üìÅ'}</span>
        <span style="color:#7f8c8d;font-size:12px;">Click below to change</span>
      </div>
      <div class="emoji-picker" id="emojiPicker">${emojiOptions}</div>
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div style="display:flex;align-items:center;gap:15px;margin-bottom:10px;">
        <div class="color-preview-swatch" id="selectedColor" style="background:${data.color || '#3498db'}"></div>
        <span style="color:#7f8c8d;font-size:12px;">This color will tint the assembly tree background</span>
      </div>
      <div class="color-picker" id="colorPicker">${colorOptions}</div>
    </div>
  `;
  
  showModal(
    isNew ? 'Create New Project' : 'Edit Project',
    body,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: isNew ? 'Create' : 'Save', class: 'btn-primary', action: () => saveProject(projectId) }
    ]
  );
  
  // Store current selections
  window._projectModalData = {
    icon: data.icon || 'üìÅ',
    color: data.color || '#3498db'
  };
}

function selectProjectEmoji(emoji) {
  window._projectModalData.icon = emoji;
  document.getElementById('selectedEmoji').textContent = emoji;
  
  // Update selection state
  document.querySelectorAll('#emojiPicker button').forEach(btn => {
    btn.classList.toggle('selected', btn.textContent === emoji);
  });
}

function selectProjectColor(color) {
  window._projectModalData.color = color;
  document.getElementById('selectedColor').style.background = color;
  
  // Update selection state
  document.querySelectorAll('#colorPicker button').forEach(btn => {
    btn.classList.toggle('selected', btn.style.background === color || rgbToHex(btn.style.background) === color);
  });
}

function rgbToHex(rgb) {
  if (rgb.startsWith('#')) return rgb;
  const match = rgb.match(/\d+/g);
  if (!match) return rgb;
  return '#' + match.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
}

async function saveProject(projectId) {
  const name = document.getElementById('projectName').value.trim();
  const description = document.getElementById('projectDesc').value.trim();
  const icon = window._projectModalData?.icon || 'üìÅ';
  const color = window._projectModalData?.color || '#3498db';
  
  if (!name) {
    showToast('Project name is required', 'error');
    return;
  }
  
  try {
    if (projectId) {
      // Update existing
      const { error } = await db.from('logi_projects').update({
        name,
        description,
        icon,
        color,
        updated_at: new Date().toISOString()
      }).eq('id', projectId);
      
      if (error) throw error;
      showToast('Project updated', 'success');
    } else {
      // Create new
      const { error } = await db.from('logi_projects').insert({
        name,
        description,
        icon,
        color,
        is_visible: true
      });
      
      if (error) throw error;
      showToast('Project created', 'success');
    }
    
    hideModal();
    await loadProjects();
  } catch (e) {
    console.error('Error saving project:', e);
    showToast('Failed to save project: ' + e.message, 'error');
  }
}

async function toggleProjectVisibility(projectId, isVisible) {
  if (!isAdmin) return;
  
  try {
    const { error } = await db.from('logi_projects').update({
      is_visible: isVisible,
      updated_at: new Date().toISOString()
    }).eq('id', projectId);
    
    if (error) throw error;
    
    // Update local state
    const project = projects.find(p => p.id === projectId);
    if (project) project.is_visible = isVisible;
    
    showToast(`Project ${isVisible ? 'visible' : 'hidden'}`, 'success');
  } catch (e) {
    console.error('Error updating visibility:', e);
    showToast('Failed to update visibility', 'error');
    // Revert checkbox
    const checkbox = document.getElementById(`vis_${projectId}`);
    if (checkbox) checkbox.checked = !isVisible;
  }
}

function confirmDeleteProject(projectId) {
  if (!isAdmin) return;
  
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  
  showModal(
    'Delete Project',
    `<p>Are you sure you want to delete "<strong>${escapeHtml(project.name)}</strong>"?</p>
     <p style="color:#e74c3c;margin-top:10px;">‚ö†Ô∏è This will also delete ALL assemblies and nodes in this project!</p>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Delete', class: 'btn-danger', action: () => deleteProject(projectId) }
    ]
  );
}

async function deleteProject(projectId) {
  try {
    const { error } = await db.from('logi_projects').delete().eq('id', projectId);
    
    if (error) throw error;
    
    hideModal();
    showToast('Project deleted', 'success');
    await loadProjects();
  } catch (e) {
    console.error('Error deleting project:', e);
    showToast('Failed to delete project: ' + e.message, 'error');
  }
}

// ============================================================
// ASSEMBLY FUNCTIONS
// ============================================================
async function loadAssemblies(projectId) {
  setStatus('Loading assemblies...', 'loading');
  
  try {
    let query = db.from('logi_assemblies').select('*').eq('project_id', projectId).order('name');
    
    // Guests only see visible assemblies
    if (!isAdmin) {
      query = query.eq('is_visible', true);
    }
    
    const { data, error } = await query;
    
    if (error) throw error;
    
    assemblies = data || [];
    renderAssemblies();
    setStatus('');
  } catch (e) {
    console.error('Error loading assemblies:', e);
    setStatus('Error loading assemblies', 'error');
    showToast('Failed to load assemblies', 'error');
  }
}

function renderAssemblies() {
  const grid = document.getElementById('assembliesGrid');
  const projectColor = currentProject?.color || '#3498db';
  
  // Filter assemblies for guests
  const visibleAssemblies = isAdmin ? assemblies : assemblies.filter(a => a.is_visible);
  
  let html = '';
  
  for (const assembly of visibleAssemblies) {
    const isHidden = !assembly.is_visible;
    html += `
      <div class="assembly-card ${isHidden ? 'hidden-assembly' : ''}" style="border-color:${projectColor}" onclick="openAssembly('${assembly.id}', '${escapeHtml(assembly.name)}')">
        <h4>${escapeHtml(assembly.name)}</h4>
        <span class="node-count" id="asmCount_${assembly.id}">Loading nodes...</span>
        ${isAdmin ? `
          <div class="assembly-card-footer">
            <div class="visibility-toggle" onclick="event.stopPropagation()">
              <input type="checkbox" id="asmVis_${assembly.id}" ${assembly.is_visible ? 'checked' : ''} onchange="toggleAssemblyVisibility('${assembly.id}', this.checked)">
              <label for="asmVis_${assembly.id}">
                <span class="toggle-switch"></span>
              </label>
            </div>
            <div class="project-card-actions">
              <button class="project-edit-btn" onclick="event.stopPropagation(); renameAssemblyById('${assembly.id}')">‚úèÔ∏è</button>
              <button class="project-delete-btn" onclick="event.stopPropagation(); confirmDeleteAssemblyById('${assembly.id}')">üóëÔ∏è</button>
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }
  
  // Add "New Assembly" card for admin
  if (isAdmin) {
    html += `
      <div class="assembly-card add-card" onclick="createNewAssembly()">
        <span style="font-size:32px;">‚ûï</span>
        <span>New Assembly</span>
      </div>
    `;
  }
  
  grid.innerHTML = html;
  
  // Load node counts
  loadAssemblyCounts();
}

async function loadAssemblyCounts() {
  for (const assembly of assemblies) {
    try {
      // Try with deleted filter first
      let result = await db.from('logi_nodes')
        .select('count', { count: 'exact', head: true })
        .eq('assembly_id', assembly.id)
        .eq('deleted', false);
      
      // If error with deleted column, try without
      if (result.error && result.error.message && result.error.message.includes('deleted')) {
        result = await db.from('logi_nodes')
          .select('count', { count: 'exact', head: true })
          .eq('assembly_id', assembly.id);
      }
      
      if (!result.error) {
        const countEl = document.getElementById(`asmCount_${assembly.id}`);
        if (countEl) {
          countEl.textContent = `${result.count || 0} node${result.count === 1 ? '' : 's'}`;
        }
      }
    } catch (e) {
      console.error('Error loading count for assembly:', assembly.id, e);
      const countEl = document.getElementById(`asmCount_${assembly.id}`);
      if (countEl) {
        countEl.textContent = '? nodes';
      }
    }
  }
}

async function openAssembly(assemblyId, assemblyName) {
  currentAssemblyId = assemblyId;
  currentAssemblyName = assemblyName;
  
  collapsedNodes.clear();
  
  // Navigate to tree page first so the SVG element exists
  navigateTo('tree');
  
  // Then load the data
  await loadAssemblyData(assemblyId);
}

async function createNewAssembly() {
  if (!isAdmin || !currentProject) return;
  
  showModal(
    'Create New Assembly',
    `<div class="form-group">
      <label class="form-label">Assembly Name</label>
      <input type="text" class="form-input" id="newAssemblyName" placeholder="Enter assembly name">
    </div>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Create', class: 'btn-primary', action: saveNewAssembly }
    ]
  );
  
  setTimeout(() => document.getElementById('newAssemblyName')?.focus(), 100);
}

async function saveNewAssembly() {
  const name = document.getElementById('newAssemblyName').value.trim();
  
  if (!name) {
    showToast('Assembly name is required', 'error');
    return;
  }
  
  try {
    const { data, error } = await db.from('logi_assemblies').insert({
      name,
      project_id: currentProject.id,
      is_visible: true
    }).select().single();
    
    if (error) throw error;
    
    hideModal();
    showToast('Assembly created', 'success');
    await loadAssemblies(currentProject.id);
  } catch (e) {
    console.error('Error creating assembly:', e);
    showToast('Failed to create assembly: ' + e.message, 'error');
  }
}

async function toggleAssemblyVisibility(assemblyId, isVisible) {
  if (!isAdmin) return;
  
  try {
    const { error } = await db.from('logi_assemblies').update({
      is_visible: isVisible,
      updated_at: new Date().toISOString()
    }).eq('id', assemblyId);
    
    if (error) throw error;
    
    // Update local state
    const assembly = assemblies.find(a => a.id === assemblyId);
    if (assembly) assembly.is_visible = isVisible;
    
    showToast(`Assembly ${isVisible ? 'visible' : 'hidden'}`, 'success');
  } catch (e) {
    console.error('Error updating visibility:', e);
    showToast('Failed to update visibility', 'error');
  }
}

function renameAssemblyById(assemblyId) {
  if (!isAdmin) return;
  
  const assembly = assemblies.find(a => a.id === assemblyId);
  if (!assembly) return;
  
  showModal(
    'Rename Assembly',
    `<div class="form-group">
      <label class="form-label">New Name</label>
      <input type="text" class="form-input" id="renameAssemblyInput" value="${escapeHtml(assembly.name)}">
    </div>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Rename', class: 'btn-primary', action: () => saveRenameAssembly(assemblyId) }
    ]
  );
  
  setTimeout(() => {
    const input = document.getElementById('renameAssemblyInput');
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);
}

async function saveRenameAssembly(assemblyId) {
  const name = document.getElementById('renameAssemblyInput').value.trim();
  
  if (!name) {
    showToast('Name is required', 'error');
    return;
  }
  
  try {
    const { error } = await db.from('logi_assemblies').update({
      name,
      updated_at: new Date().toISOString()
    }).eq('id', assemblyId);
    
    if (error) throw error;
    
    hideModal();
    showToast('Assembly renamed', 'success');
    await loadAssemblies(currentProject.id);
  } catch (e) {
    console.error('Error renaming assembly:', e);
    showToast('Failed to rename: ' + e.message, 'error');
  }
}

function confirmDeleteAssemblyById(assemblyId) {
  if (!isAdmin) return;
  
  const assembly = assemblies.find(a => a.id === assemblyId);
  if (!assembly) return;
  
  showModal(
    'Delete Assembly',
    `<p>Are you sure you want to delete "<strong>${escapeHtml(assembly.name)}</strong>"?</p>
     <p style="color:#e74c3c;margin-top:10px;">‚ö†Ô∏è This will delete all nodes and links in this assembly!</p>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Delete', class: 'btn-danger', action: () => deleteAssemblyById(assemblyId) }
    ]
  );
}

async function deleteAssemblyById(assemblyId) {
  try {
    // Delete links first
    await db.from('logi_links').delete().eq('assembly_id', assemblyId);
    
    // Delete nodes
    await db.from('logi_nodes').delete().eq('assembly_id', assemblyId);
    
    // Delete assembly
    const { error } = await db.from('logi_assemblies').delete().eq('id', assemblyId);
    
    if (error) throw error;
    
    hideModal();
    showToast('Assembly deleted', 'success');
    await loadAssemblies(currentProject.id);
  } catch (e) {
    console.error('Error deleting assembly:', e);
    showToast('Failed to delete: ' + e.message, 'error');
  }
}

// ============================================================
// TREE DATA LOADING
// ============================================================
async function loadAssemblyData(assemblyId) {
  setStatus('Loading assembly...', 'loading');
  
  // Only show loading overlay if tree page exists and is visible
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay) {
    loadingOverlay.classList.add('show');
  }
  
  try {
    console.log('Loading assembly:', assemblyId);
    
    // Load nodes - handle both with and without 'deleted' column
    let nodeQuery = db.from('logi_nodes').select('*').eq('assembly_id', assemblyId);
    
    // Try with deleted filter first
    let { data: nodeData, error: nodeError } = await nodeQuery.eq('deleted', false);
    
    // If error mentions 'deleted' column, try without it
    if (nodeError && nodeError.message && nodeError.message.includes('deleted')) {
      console.log('Retrying without deleted filter...');
      const result = await db.from('logi_nodes').select('*').eq('assembly_id', assemblyId);
      nodeData = result.data;
      nodeError = result.error;
    }
    
    if (nodeError) {
      console.error('Node query error:', nodeError);
      throw nodeError;
    }
    
    console.log('Loaded nodes:', nodeData?.length || 0);
    
    // Load links
    const { data: linkData, error: linkError } = await db
      .from('logi_links')
      .select('*')
      .eq('assembly_id', assemblyId);
    
    if (linkError) {
      console.error('Link query error:', linkError);
      throw linkError;
    }
    
    console.log('Loaded links:', linkData?.length || 0);
    
    // Process data
    nodes = (nodeData || []).map(n => ({
      ...n,
      receivesFrom: [],
      goesInto: []
    }));
    
    links = linkData || [];
    
    // Build relationships
    const nodeMap = new Map(nodes.map(n => [n.id, n]));
    
    for (const link of links) {
      const parent = nodeMap.get(link.parent_id);
      const child = nodeMap.get(link.child_id);
      
      if (parent && child) {
        parent.receivesFrom.push(child.id);
        child.goesInto.push(parent.id);
      }
    }
    
    // Restore locked nodes
    lockedNodes.clear();
    for (const n of nodes) {
      if (n.is_locked) {
        lockedNodes.add(n.id);
      }
    }
    
    console.log('Data processed, rendering graph...');
    renderGraph();
    setStatus('');
    return true;
  } catch (e) {
    console.error('Error loading assembly data:', e);
    setStatus('Error: ' + (e.message || 'Loading failed'), 'error');
    showToast('Failed to load: ' + (e.message || 'Unknown error'), 'error');
    return false;
  } finally {
    if (loadingOverlay) {
      loadingOverlay.classList.remove('show');
    }
  }
}

// ============================================================
// GRAPH RENDERING
// ============================================================
function renderGraph() {
  const container = document.getElementById('treeContainer');
  const svg = d3.select('#treeSvg');
  
  svg.selectAll('*').remove();
  
  if (nodes.length === 0) {
    svg.attr('width', container.clientWidth)
       .attr('height', container.clientHeight);
    
    svg.append('text')
      .attr('x', container.clientWidth / 2)
      .attr('y', container.clientHeight / 2)
      .attr('text-anchor', 'middle')
      .attr('fill', '#999')
      .attr('font-size', '16px')
      .text(isAdmin ? 'No nodes yet. Right-click to add one.' : 'No nodes in this assembly.');
    
    return;
  }
  
  // Filter by level
  let visibleNodes = nodes;
  if (currentLevelFilter !== 'all') {
    const maxLevel = parseInt(currentLevelFilter);
    visibleNodes = nodes.filter(n => n.level <= maxLevel);
  }
  
  // Handle collapsed nodes
  const hiddenNodeIds = new Set();
  
  function hideDescendants(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;
    
    for (const childId of node.receivesFrom) {
      if (!hiddenNodeIds.has(childId)) {
        hiddenNodeIds.add(childId);
        hideDescendants(childId);
      }
    }
  }
  
  for (const collapsedId of collapsedNodes) {
    hideDescendants(collapsedId);
  }
  
  visibleNodes = visibleNodes.filter(n => !hiddenNodeIds.has(n.id));
  
  // Filter links
  const visibleNodeIds = new Set(visibleNodes.map(n => n.id));
  const visibleLinks = links.filter(l => 
    visibleNodeIds.has(l.parent_id) && visibleNodeIds.has(l.child_id)
  );
  
  // Calculate dimensions
  const width = Math.max(container.clientWidth, visibleNodes.length * 80);
  const height = Math.max(container.clientHeight, visibleNodes.length * 50);
  
  svg.attr('width', width).attr('height', height);
  
  // Create main group
  const g = svg.append('g').attr('class', 'main');
  
  // Draw links
  const linkG = g.append('g').attr('class', 'links');
  
  const linkSelection = linkG.selectAll('.link-group')
    .data(visibleLinks, d => `${d.parent_id}-${d.child_id}`)
    .enter()
    .append('g')
    .attr('class', 'link-group');
  
  linkSelection.append('path')
    .attr('class', 'link')
    .attr('stroke', d => {
      if (d.fastener) {
        const prefix = d.fastener.split('-')[0].toUpperCase();
        return FASTENER_COLORS[prefix] || FASTENER_COLORS.OTHER;
      }
      return '#999';
    })
    .attr('stroke-width', 2)
    .on('click', function(event, d) {
      event.stopPropagation();
      selectLink(d);
    })
    .on('contextmenu', function(event, d) {
      event.preventDefault();
      if (isAdmin) showLinkContextMenu(event, d);
    });
  
  // Link labels
  linkSelection.each(function(d) {
    if (d.fastener) {
      const group = d3.select(this);
      
      group.append('rect')
        .attr('class', 'link-label-bg')
        .attr('rx', 3)
        .attr('ry', 3);
      
      group.append('text')
        .attr('class', 'link-label')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.35em')
        .text(`${d.fastener}${d.fastener_qty > 1 ? ' √ó' + d.fastener_qty : ''}`);
    }
  });
  
  // Draw nodes
  const nodeG = g.append('g').attr('class', 'nodes');
  
  const nodeSelection = nodeG.selectAll('.node')
    .data(visibleNodes, d => d.id)
    .enter()
    .append('g')
    .attr('class', d => {
      let classes = 'node';
      if (selectedNode && selectedNode.id === d.id) classes += ' selected';
      if (lockedNodes.has(d.id)) classes += ' locked';
      if (d.goesInto.length === 0 && d.level > 1) classes += ' orphan';
      return classes;
    });
  
  // Add shapes
  nodeSelection.each(function(d) {
    const group = d3.select(this);
    const nodeWidth = Math.min(NODE_WIDTH_MAX, Math.max(NODE_WIDTH_BASE, (d.name?.length || 0) * 6 + 40));
    const nodeHeight = 40;
    
    const shapeIndex = Math.min((d.level || 1) - 1, LEVEL_SHAPES.length - 1);
    const shape = LEVEL_SHAPES[shapeIndex];
    
    let fill = LEVEL_COLORS[Math.min((d.level || 1) - 1, LEVEL_COLORS.length - 1)];
    let stroke = '#666';
    
    if (currentColorMode === 'status') {
      const statusColor = STATUS_COLORS[d.status] || STATUS_COLORS.NOT_STARTED;
      fill = statusColor.bg;
      stroke = statusColor.stroke;
    } else if (currentColorMode === 'group') {
      const groupIndex = (d.group_id || 0) % GROUP_COLORS.length;
      fill = GROUP_COLORS[groupIndex];
      stroke = '#333';
    }
    
    // Draw shape based on level
    drawNodeShape(group, shape, nodeWidth, nodeHeight, fill, stroke, d);
    
    // Node label
    group.append('text')
      .attr('class', 'node-label')
      .attr('text-anchor', 'middle')
      .attr('dy', d.part_number ? '-0.1em' : '0.35em')
      .attr('font-size', '11px')
      .text(truncateText(d.name || 'Unnamed', 18));
    
    // Part number
    if (d.part_number) {
      group.append('text')
        .attr('class', 'node-pn')
        .attr('text-anchor', 'middle')
        .attr('dy', '1.2em')
        .attr('font-size', '8px')
        .text(truncateText(d.part_number, 20));
    }
    
    // Lock indicator
    if (lockedNodes.has(d.id)) {
      group.append('text')
        .attr('class', 'lock-indicator')
        .attr('x', nodeWidth / 2 - 8)
        .attr('y', -nodeHeight / 2 + 10)
        .text('üîí');
    }
    
    // Multi-parent indicator
    if (d.goesInto.length > 1) {
      group.append('circle')
        .attr('class', 'multi-parent-indicator')
        .attr('cx', -nodeWidth / 2 + 8)
        .attr('cy', -nodeHeight / 2 + 8)
        .attr('r', 6)
        .attr('stroke', '#9b59b6')
        .attr('fill', 'white');
      
      group.append('text')
        .attr('x', -nodeWidth / 2 + 8)
        .attr('y', -nodeHeight / 2 + 11)
        .attr('text-anchor', 'middle')
        .attr('font-size', '8px')
        .attr('fill', '#9b59b6')
        .text(d.goesInto.length);
    }
    
    // Collapse indicator
    if (d.receivesFrom.length > 0) {
      const isCollapsed = collapsedNodes.has(d.id);
      
      group.append('circle')
        .attr('class', 'collapse-indicator')
        .attr('cx', 0)
        .attr('cy', nodeHeight / 2 + 8)
        .attr('r', 8)
        .on('click', function(event) {
          event.stopPropagation();
          toggleCollapse(d.id);
        });
      
      group.append('text')
        .attr('class', 'toggle-icon')
        .attr('x', 0)
        .attr('y', nodeHeight / 2 + 12)
        .attr('text-anchor', 'middle')
        .text(isCollapsed ? '+' : '‚àí');
    }
    
    // Sequence badge
    if (d.sequence != null && d.sequence >= 0) {
      group.append('text')
        .attr('class', 'sequence-badge')
        .attr('x', nodeWidth / 2 - 5)
        .attr('y', -nodeHeight / 2 + 12)
        .attr('text-anchor', 'end')
        .text(SEQUENCE_BADGES[Math.min(d.sequence, SEQUENCE_BADGES.length - 1)]);
    }
  });
  
  // Node interactions
  nodeSelection
    .on('click', function(event, d) {
      event.stopPropagation();
      selectNode(d);
    })
    .on('dblclick', function(event, d) {
      event.stopPropagation();
      if (isAdmin) openNodeEditor(d);
    })
    .on('contextmenu', function(event, d) {
      event.preventDefault();
      showNodeContextMenu(event, d);
    });
  
  // Drag behavior (admin only)
  if (isAdmin) {
    nodeSelection.call(d3.drag()
      .on('start', dragStarted)
      .on('drag', dragged)
      .on('end', dragEnded)
    );
  }
  
  // Position nodes
  positionNodes(visibleNodes, visibleLinks, width, height);
  
  // Update positions
  updatePositions();
}

function drawNodeShape(group, shape, width, height, fill, stroke, nodeData) {
  const hw = width / 2;
  const hh = height / 2;
  
  let path;
  
  switch (shape) {
    case 'rectangle':
      path = group.append('rect')
        .attr('x', -hw)
        .attr('y', -hh)
        .attr('width', width)
        .attr('height', height);
      break;
      
    case 'rounded_rectangle':
      path = group.append('rect')
        .attr('x', -hw)
        .attr('y', -hh)
        .attr('width', width)
        .attr('height', height)
        .attr('rx', 8)
        .attr('ry', 8);
      break;
      
    case 'pentagon':
      const pentPoints = [
        [0, -hh],
        [hw, -hh * 0.4],
        [hw * 0.7, hh],
        [-hw * 0.7, hh],
        [-hw, -hh * 0.4]
      ];
      path = group.append('polygon')
        .attr('points', pentPoints.map(p => p.join(',')).join(' '));
      break;
      
    case 'stadium':
      path = group.append('rect')
        .attr('x', -hw)
        .attr('y', -hh)
        .attr('width', width)
        .attr('height', height)
        .attr('rx', hh)
        .attr('ry', hh);
      break;
      
    case 'parallelogram':
      const offset = 10;
      const paraPoints = [
        [-hw + offset, -hh],
        [hw + offset, -hh],
        [hw - offset, hh],
        [-hw - offset, hh]
      ];
      path = group.append('polygon')
        .attr('points', paraPoints.map(p => p.join(',')).join(' '));
      break;
      
    case 'hexagon':
      const hexPoints = [
        [-hw * 0.7, -hh],
        [hw * 0.7, -hh],
        [hw, 0],
        [hw * 0.7, hh],
        [-hw * 0.7, hh],
        [-hw, 0]
      ];
      path = group.append('polygon')
        .attr('points', hexPoints.map(p => p.join(',')).join(' '));
      break;
      
    case 'ellipse':
      path = group.append('ellipse')
        .attr('cx', 0)
        .attr('cy', 0)
        .attr('rx', hw)
        .attr('ry', hh);
      break;
      
    case 'octagon':
      const corner = 10;
      const octPoints = [
        [-hw + corner, -hh],
        [hw - corner, -hh],
        [hw, -hh + corner],
        [hw, hh - corner],
        [hw - corner, hh],
        [-hw + corner, hh],
        [-hw, hh - corner],
        [-hw, -hh + corner]
      ];
      path = group.append('polygon')
        .attr('points', octPoints.map(p => p.join(',')).join(' '));
      break;
      
    default:
      path = group.append('rect')
        .attr('x', -hw)
        .attr('y', -hh)
        .attr('width', width)
        .attr('height', height);
  }
  
  path.attr('class', 'node-shape')
    .attr('fill', fill)
    .attr('stroke', stroke)
    .attr('stroke-width', 2);
  
  // Dashed border for orphans
  if (nodeData.goesInto.length === 0 && nodeData.level > 1) {
    path.attr('stroke-dasharray', '4,2');
  }
}

function positionNodes(visibleNodes, visibleLinks, width, height) {
  // Initialize positions for nodes without saved positions
  for (const node of visibleNodes) {
    if (node.x == null || node.y == null) {
      if (currentLayoutMode === 'radial' && node.level >= 3) {
        // Radial positioning for L3+
        const parentIds = node.goesInto;
        if (parentIds.length > 0) {
          const parent = visibleNodes.find(n => n.id === parentIds[0]);
          if (parent && parent.x != null && parent.y != null) {
            const angle = Math.random() * Math.PI * 2;
            const radius = RADIAL_RADIUS + Math.random() * 50;
            node.x = parent.x + Math.cos(angle) * radius;
            node.y = parent.y + Math.sin(angle) * radius;
          } else {
            node.x = width / 2 + (Math.random() - 0.5) * 200;
            node.y = 100 + node.level * 100 + (Math.random() - 0.5) * 50;
          }
        } else {
          node.x = width / 2 + (Math.random() - 0.5) * 200;
          node.y = 100 + node.level * 100;
        }
      } else {
        // Default hierarchical positioning
        node.x = width / 2 + (Math.random() - 0.5) * 200;
        node.y = 100 + (node.level || 1) * 100 + (Math.random() - 0.5) * 50;
      }
    }
    
    // Fix position for locked nodes
    if (lockedNodes.has(node.id)) {
      node.fx = node.x;
      node.fy = node.y;
    } else {
      node.fx = null;
      node.fy = null;
    }
  }
  
  // Setup force simulation
  if (simulation) simulation.stop();
  
  simulation = d3.forceSimulation(visibleNodes)
    .force('link', d3.forceLink(visibleLinks)
      .id(d => d.id)
      .distance(120)
      .strength(0.5)
    )
    .force('charge', d3.forceManyBody().strength(-300))
    .force('collide', d3.forceCollide().radius(70))
    .force('y', d3.forceY(d => 100 + (d.level || 1) * 100).strength(0.1))
    .force('center', d3.forceCenter(width / 2, height / 2).strength(0.02))
    .alpha(0.3)
    .alphaDecay(0.02)
    .on('tick', updatePositions);
}

function updatePositions() {
  const svg = d3.select('#treeSvg');
  
  // Update node positions
  svg.selectAll('.node')
    .attr('transform', d => `translate(${d.x || 0}, ${d.y || 0})`);
  
  // Update link paths
  svg.selectAll('.link-group').each(function(d) {
    const source = nodes.find(n => n.id === d.child_id);
    const target = nodes.find(n => n.id === d.parent_id);
    
    if (source && target && source.x != null && target.x != null) {
      const path = d3.select(this).select('.link');
      const pathD = `M${source.x},${source.y} Q${(source.x + target.x) / 2},${(source.y + target.y) / 2 - 30} ${target.x},${target.y}`;
      path.attr('d', pathD);
      
      // Update label position
      const midX = (source.x + target.x) / 2;
      const midY = (source.y + target.y) / 2 - 15;
      
      const label = d3.select(this).select('.link-label');
      const bg = d3.select(this).select('.link-label-bg');
      
      if (!label.empty()) {
        label.attr('x', midX).attr('y', midY);
        
        const bbox = label.node().getBBox();
        bg.attr('x', bbox.x - 3)
          .attr('y', bbox.y - 2)
          .attr('width', bbox.width + 6)
          .attr('height', bbox.height + 4);
      }
    }
  });
}

// ============================================================
// DRAG HANDLERS
// ============================================================
function dragStarted(event, d) {
  if (!isAdmin) return;
  
  // Save position history for undo
  savePositionState();
  
  if (!event.active) simulation.alphaTarget(0.1).restart();
  
  d.fx = d.x;
  d.fy = d.y;
  
  // Check if dragging with children (shift key)
  if (shiftKeyPressed) {
    highlightChildren(d.id);
  }
  
  // Check if dragging an orphan
  if (d.goesInto.length === 0 && d.level > 1) {
    draggingOrphan = d;
  }
}

function dragged(event, d) {
  if (!isAdmin) return;
  
  d.fx = event.x;
  d.fy = event.y;
  d.x = event.x;
  d.y = event.y;
  
  // Move children if shift is held
  if (shiftKeyPressed) {
    moveChildren(d.id, event.dx, event.dy);
  }
  
  // Check for drop targets when dragging orphan
  if (draggingOrphan) {
    checkDropTarget(event.x, event.y);
  }
  
  updatePositions();
}

function dragEnded(event, d) {
  if (!isAdmin) return;
  
  if (!event.active) simulation.alphaTarget(0);
  
  // Don't release if locked
  if (!lockedNodes.has(d.id)) {
    d.fx = null;
    d.fy = null;
  }
  
  // Clear highlights
  d3.selectAll('.node').classed('child-highlight', false).classed('dragging-children', false);
  
  // Handle orphan reconnection
  if (draggingOrphan && dropTarget) {
    reconnectOrphan(draggingOrphan, dropTarget);
  }
  
  draggingOrphan = null;
  dropTarget = null;
  d3.selectAll('.node').classed('drop-target', false);
}

function highlightChildren(nodeId) {
  const descendants = getDescendants(nodeId);
  d3.selectAll('.node')
    .classed('child-highlight', d => descendants.has(d.id))
    .classed('dragging-children', d => descendants.has(d.id));
}

function moveChildren(nodeId, dx, dy) {
  const descendants = getDescendants(nodeId);
  
  for (const node of nodes) {
    if (descendants.has(node.id)) {
      node.x += dx;
      node.y += dy;
      if (lockedNodes.has(node.id)) {
        node.fx = node.x;
        node.fy = node.y;
      }
    }
  }
}

function getDescendants(nodeId) {
  const descendants = new Set();
  
  function traverse(id) {
    const node = nodes.find(n => n.id === id);
    if (!node) return;
    
    for (const childId of node.receivesFrom) {
      if (!descendants.has(childId)) {
        descendants.add(childId);
        traverse(childId);
      }
    }
  }
  
  traverse(nodeId);
  return descendants;
}

function checkDropTarget(x, y) {
  let closest = null;
  let closestDist = Infinity;
  
  for (const node of nodes) {
    if (node.id === draggingOrphan.id) continue;
    if (node.level >= draggingOrphan.level) continue;
    
    const dist = Math.hypot(node.x - x, node.y - y);
    if (dist < 80 && dist < closestDist) {
      closest = node;
      closestDist = dist;
    }
  }
  
  d3.selectAll('.node').classed('drop-target', false);
  
  if (closest) {
    dropTarget = closest;
    d3.selectAll('.node').filter(d => d.id === closest.id).classed('drop-target', true);
  } else {
    dropTarget = null;
  }
}

async function reconnectOrphan(orphan, parent) {
  if (!isAdmin) return;
  
  try {
    const { error } = await db.from('logi_links').insert({
      assembly_id: currentAssemblyId,
      child_id: orphan.id,
      parent_id: parent.id
    });
    
    if (error) throw error;
    
    showToast(`Connected "${orphan.name}" to "${parent.name}"`, 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error reconnecting orphan:', e);
    showToast('Failed to connect nodes', 'error');
  }
}

// ============================================================
// SELECTION
// ============================================================
function selectNode(node) {
  selectedNode = node;
  selectedLink = null;
  
  d3.selectAll('.node').classed('selected', d => d.id === node.id);
  d3.selectAll('.link').classed('selected', false);
}

function selectLink(link) {
  selectedLink = link;
  selectedNode = null;
  
  d3.selectAll('.node').classed('selected', false);
  d3.selectAll('.link').classed('selected', d => 
    d.parent_id === link.parent_id && d.child_id === link.child_id
  );
}

function clearSelection() {
  selectedNode = null;
  selectedLink = null;
  
  d3.selectAll('.node').classed('selected', false);
  d3.selectAll('.link').classed('selected', false);
}

// ============================================================
// CONTEXT MENUS
// ============================================================
function showNodeContextMenu(event, node) {
  const menu = document.getElementById('contextMenu');
  
  let menuItems = '';
  
  if (isAdmin) {
    menuItems = `
      <div class="context-menu-item" onclick="openNodeEditor(getNodeById('${node.id}'))">
        <span class="context-menu-icon">‚úèÔ∏è</span> Edit Node
      </div>
      <div class="context-menu-item" onclick="duplicateNode('${node.id}')">
        <span class="context-menu-icon">üìã</span> Duplicate
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="showConnectToParentSubmenu(event, '${node.id}')">
        <span class="context-menu-icon">üîó</span> Connect to Parent ‚ñ∂
      </div>
      <div class="context-menu-item" onclick="addChildNode('${node.id}')">
        <span class="context-menu-icon">‚ûï</span> Add Child
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="toggleNodeLock('${node.id}')">
        <span class="context-menu-icon">${lockedNodes.has(node.id) ? 'üîì' : 'üîí'}</span>
        ${lockedNodes.has(node.id) ? 'Unlock Position' : 'Lock Position'}
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item danger" onclick="confirmDeleteNode('${node.id}')">
        <span class="context-menu-icon">üóëÔ∏è</span> Delete Node
      </div>
    `;
  } else {
    menuItems = `
      <div class="context-menu-item" onclick="viewNodeDetails(getNodeById('${node.id}'))">
        <span class="context-menu-icon">üëÅÔ∏è</span> View Details
      </div>
    `;
  }
  
  menu.innerHTML = menuItems;
  
  positionContextMenu(menu, event.clientX, event.clientY);
  menu.classList.add('show');
}

function showConnectToParentSubmenu(event, nodeId) {
  event.stopPropagation();
  
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  
  // Get potential parents (nodes at same or higher level, not already connected)
  const potentialParents = nodes.filter(n => 
    n.id !== nodeId && 
    n.level < node.level &&
    !node.goesInto.includes(n.id)
  ).sort((a, b) => a.level - b.level || a.name.localeCompare(b.name));
  
  const menu = document.getElementById('contextMenu');
  
  let menuItems = `
    <div class="context-menu-item" onclick="showNodeContextMenu(event, getNodeById('${nodeId}'))">
      <span class="context-menu-icon">‚óÄ</span> Back
    </div>
    <div class="context-menu-divider"></div>
  `;
  
  if (potentialParents.length === 0) {
    menuItems += `
      <div class="context-menu-item" style="color:#999;cursor:default;">
        No available parents
      </div>
    `;
  } else {
    for (const parent of potentialParents.slice(0, 10)) {
      menuItems += `
        <div class="context-menu-item" onclick="event.stopPropagation(); connectToParent('${nodeId}', '${parent.id}')">
          <span class="context-menu-icon">L${parent.level}</span>
          ${escapeHtml(truncateText(parent.name, 20))}
        </div>
      `;
    }
    
    if (potentialParents.length > 10) {
      menuItems += `
        <div class="context-menu-item" style="color:#999;font-size:11px;">
          +${potentialParents.length - 10} more...
        </div>
      `;
    }
  }
  
  menu.innerHTML = menuItems;
}

async function connectToParent(childId, parentId) {
  hideContextMenu();
  
  if (!isAdmin) return;
  
  try {
    const { error } = await db.from('logi_links').insert({
      assembly_id: currentAssemblyId,
      child_id: childId,
      parent_id: parentId
    });
    
    if (error) throw error;
    
    const child = nodes.find(n => n.id === childId);
    const parent = nodes.find(n => n.id === parentId);
    
    showToast(`Connected "${child?.name}" to "${parent?.name}"`, 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error connecting nodes:', e);
    showToast('Failed to connect: ' + e.message, 'error');
  }
}

function showLinkContextMenu(event, link) {
  const menu = document.getElementById('contextMenu');
  
  menu.innerHTML = `
    <div class="context-menu-item" onclick="editLink('${link.parent_id}', '${link.child_id}')">
      <span class="context-menu-icon">‚úèÔ∏è</span> Edit Fastener
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="confirmDeleteLink('${link.parent_id}', '${link.child_id}')">
      <span class="context-menu-icon">üóëÔ∏è</span> Delete Connection
    </div>
  `;
  
  positionContextMenu(menu, event.clientX, event.clientY);
  menu.classList.add('show');
}

function positionContextMenu(menu, x, y) {
  menu.style.left = `${x}px`;
  menu.style.top = `${y}px`;
  
  // Adjust if off screen
  setTimeout(() => {
    const rect = menu.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
      menu.style.left = `${window.innerWidth - rect.width - 10}px`;
    }
    if (rect.bottom > window.innerHeight) {
      menu.style.top = `${window.innerHeight - rect.height - 10}px`;
    }
  }, 0);
}

function hideContextMenu() {
  document.getElementById('contextMenu').classList.remove('show');
}

function getNodeById(id) {
  return nodes.find(n => n.id === id);
}

// ============================================================
// NODE OPERATIONS
// ============================================================
function openNodeEditor(node) {
  if (!isAdmin || !node) return;
  
  const panel = document.getElementById('sidePanel');
  
  document.getElementById('panelTitle').textContent = 'Edit Node';
  
  document.getElementById('panelContent').innerHTML = `
    <div class="form-group">
      <label class="form-label">Name</label>
      <input type="text" class="form-input" id="editNodeName" value="${escapeHtml(node.name || '')}">
    </div>
    <div class="form-group">
      <label class="form-label">Part Number</label>
      <input type="text" class="form-input" id="editNodePN" value="${escapeHtml(node.part_number || '')}">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Level</label>
        <input type="number" class="form-input" id="editNodeLevel" value="${node.level || 1}" min="1" max="8">
      </div>
      <div class="form-group">
        <label class="form-label">Sequence</label>
        <input type="number" class="form-input" id="editNodeSeq" value="${node.sequence ?? ''}" min="0" max="20">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select class="form-select" id="editNodeStatus">
        <option value="NOT_STARTED" ${node.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
        <option value="IN_PROGRESS" ${node.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
        <option value="DONE" ${node.status === 'DONE' ? 'selected' : ''}>Done</option>
        <option value="BLOCKED" ${node.status === 'BLOCKED' ? 'selected' : ''}>Blocked</option>
        <option value="ON_HOLD" ${node.status === 'ON_HOLD' ? 'selected' : ''}>On Hold</option>
        <option value="REVIEW" ${node.status === 'REVIEW' ? 'selected' : ''}>Review</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Group ID</label>
      <input type="number" class="form-input" id="editNodeGroup" value="${node.group_id ?? 0}" min="0">
    </div>
    <div class="form-group">
      <label class="form-label">Notes</label>
      <textarea class="form-textarea" id="editNodeNotes">${escapeHtml(node.notes || '')}</textarea>
    </div>
  `;
  
  document.getElementById('panelFooter').innerHTML = `
    <button class="btn btn-secondary" onclick="closeSidePanel()">Cancel</button>
    <button class="btn btn-primary" onclick="saveNodeEdit('${node.id}')">Save</button>
  `;
  
  panel.classList.add('open');
}

async function saveNodeEdit(nodeId) {
  const name = document.getElementById('editNodeName').value.trim();
  const part_number = document.getElementById('editNodePN').value.trim();
  const level = parseInt(document.getElementById('editNodeLevel').value) || 1;
  const sequence = document.getElementById('editNodeSeq').value !== '' ? parseInt(document.getElementById('editNodeSeq').value) : null;
  const status = document.getElementById('editNodeStatus').value;
  const group_id = parseInt(document.getElementById('editNodeGroup').value) || 0;
  const notes = document.getElementById('editNodeNotes').value.trim();
  
  if (!name) {
    showToast('Name is required', 'error');
    return;
  }
  
  try {
    const { error } = await db.from('logi_nodes').update({
      name,
      part_number: part_number || null,
      level,
      sequence,
      status,
      group_id,
      notes: notes || null,
      updated_at: new Date().toISOString()
    }).eq('id', nodeId);
    
    if (error) throw error;
    
    closeSidePanel();
    showToast('Node updated', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error updating node:', e);
    showToast('Failed to update: ' + e.message, 'error');
  }
}

function viewNodeDetails(node) {
  if (!node) return;
  
  hideContextMenu();
  
  const panel = document.getElementById('sidePanel');
  
  document.getElementById('panelTitle').textContent = 'Node Details';
  
  document.getElementById('panelContent').innerHTML = `
    <div class="form-group">
      <label class="form-label">Name</label>
      <div style="padding:10px;background:#f8f9fa;border-radius:6px;">${escapeHtml(node.name || 'Unnamed')}</div>
    </div>
    <div class="form-group">
      <label class="form-label">Part Number</label>
      <div style="padding:10px;background:#f8f9fa;border-radius:6px;">${escapeHtml(node.part_number || '-')}</div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Level</label>
        <div style="padding:10px;background:#f8f9fa;border-radius:6px;">L${node.level || 1}</div>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <div style="padding:10px;background:#f8f9fa;border-radius:6px;">${node.status || 'NOT_STARTED'}</div>
      </div>
    </div>
    ${node.notes ? `
      <div class="form-group">
        <label class="form-label">Notes</label>
        <div style="padding:10px;background:#f8f9fa;border-radius:6px;white-space:pre-wrap;">${escapeHtml(node.notes)}</div>
      </div>
    ` : ''}
  `;
  
  document.getElementById('panelFooter').innerHTML = `
    <button class="btn btn-secondary" onclick="closeSidePanel()">Close</button>
  `;
  
  panel.classList.add('open');
}

async function addChildNode(parentId) {
  hideContextMenu();
  
  if (!isAdmin) return;
  
  const parent = nodes.find(n => n.id === parentId);
  if (!parent) return;
  
  showModal(
    'Add Child Node',
    `<div class="form-group">
      <label class="form-label">Node Name</label>
      <input type="text" class="form-input" id="newChildName" placeholder="Enter node name">
    </div>
    <div class="form-group">
      <label class="form-label">Part Number (optional)</label>
      <input type="text" class="form-input" id="newChildPN" placeholder="Enter part number">
    </div>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Add', class: 'btn-primary', action: () => saveChildNode(parentId) }
    ]
  );
  
  setTimeout(() => document.getElementById('newChildName')?.focus(), 100);
}

async function saveChildNode(parentId) {
  const name = document.getElementById('newChildName').value.trim();
  const part_number = document.getElementById('newChildPN').value.trim();
  
  if (!name) {
    showToast('Name is required', 'error');
    return;
  }
  
  const parent = nodes.find(n => n.id === parentId);
  const childLevel = (parent?.level || 1) + 1;
  
  try {
    // Create node
    const { data: newNode, error: nodeError } = await db.from('logi_nodes').insert({
      assembly_id: currentAssemblyId,
      name,
      part_number: part_number || null,
      level: childLevel,
      status: 'NOT_STARTED',
      x: (parent?.x || 400) + (Math.random() - 0.5) * 100,
      y: (parent?.y || 200) + 100
    }).select().single();
    
    if (nodeError) throw nodeError;
    
    // Create link
    const { error: linkError } = await db.from('logi_links').insert({
      assembly_id: currentAssemblyId,
      child_id: newNode.id,
      parent_id: parentId
    });
    
    if (linkError) throw linkError;
    
    hideModal();
    showToast('Node added', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error adding child node:', e);
    showToast('Failed to add node: ' + e.message, 'error');
  }
}

async function duplicateNode(nodeId) {
  hideContextMenu();
  
  if (!isAdmin) return;
  
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  
  try {
    // Create copy of node
    const { data: newNode, error } = await db.from('logi_nodes').insert({
      assembly_id: currentAssemblyId,
      name: node.name + ' (copy)',
      part_number: node.part_number,
      level: node.level,
      status: node.status,
      group_id: node.group_id,
      notes: node.notes,
      x: (node.x || 400) + 50,
      y: (node.y || 200) + 50
    }).select().single();
    
    if (error) throw error;
    
    // Copy parent links
    for (const targetId of node.goesInto) {
      const link = links.find(l => l.child_id === nodeId && l.parent_id === targetId);
      if (link) {
        await db.from('logi_links').insert({
          assembly_id: currentAssemblyId,
          child_id: newNode.id,
          parent_id: targetId,
          fastener: link.fastener,
          fastener_qty: link.fastener_qty
        });
      }
    }
    
    showToast('Node duplicated', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error duplicating node:', e);
    showToast('Failed to duplicate: ' + e.message, 'error');
  }
}

function toggleNodeLock(nodeId) {
  hideContextMenu();
  
  if (lockedNodes.has(nodeId)) {
    lockedNodes.delete(nodeId);
    const node = nodes.find(n => n.id === nodeId);
    if (node) {
      node.fx = null;
      node.fy = null;
    }
    showToast('Node unlocked', 'success');
  } else {
    lockedNodes.add(nodeId);
    const node = nodes.find(n => n.id === nodeId);
    if (node) {
      node.fx = node.x;
      node.fy = node.y;
    }
    showToast('Node locked', 'success');
  }
  
  renderGraph();
}

function confirmDeleteNode(nodeId) {
  hideContextMenu();
  
  const node = nodes.find(n => n.id === nodeId);
  if (!node) return;
  
  const childCount = node.receivesFrom.length;
  const warningText = childCount > 0 
    ? `<p style="color:#e74c3c;margin-top:10px;">‚ö†Ô∏è This node has ${childCount} child node(s). They will become orphans.</p>`
    : '';
  
  showModal(
    'Delete Node',
    `<p>Are you sure you want to delete "<strong>${escapeHtml(node.name)}</strong>"?</p>${warningText}`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Delete', class: 'btn-danger', action: () => deleteNode(nodeId) }
    ]
  );
}

async function deleteNode(nodeId) {
  try {
    // Soft delete - just mark as deleted
    const { error } = await db.from('logi_nodes').update({
      deleted: true,
      updated_at: new Date().toISOString()
    }).eq('id', nodeId);
    
    if (error) throw error;
    
    // Delete associated links
    await db.from('logi_links').delete().or(`child_id.eq.${nodeId},parent_id.eq.${nodeId}`);
    
    hideModal();
    showToast('Node deleted', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error deleting node:', e);
    showToast('Failed to delete: ' + e.message, 'error');
  }
}

// ============================================================
// LINK OPERATIONS
// ============================================================
function editLink(parentId, childId) {
  hideContextMenu();
  
  const link = links.find(l => l.parent_id === parentId && l.child_id === childId);
  if (!link) return;
  
  const parent = nodes.find(n => n.id === parentId);
  const child = nodes.find(n => n.id === childId);
  
  const panel = document.getElementById('sidePanel');
  
  document.getElementById('panelTitle').textContent = 'Edit Connection';
  
  document.getElementById('panelContent').innerHTML = `
    <div class="form-group">
      <label class="form-label">Connection</label>
      <div style="padding:10px;background:#f8f9fa;border-radius:6px;font-size:12px;">
        ${escapeHtml(child?.name || 'Child')} ‚Üí ${escapeHtml(parent?.name || 'Parent')}
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Fastener</label>
      <input type="text" class="form-input" id="editLinkFastener" value="${escapeHtml(link.fastener || '')}" placeholder="e.g., CBE-M4x10">
    </div>
    <div class="form-group">
      <label class="form-label">Quantity</label>
      <input type="number" class="form-input" id="editLinkQty" value="${link.fastener_qty || 1}" min="1">
    </div>
  `;
  
  document.getElementById('panelFooter').innerHTML = `
    <button class="btn btn-secondary" onclick="closeSidePanel()">Cancel</button>
    <button class="btn btn-primary" onclick="saveLinkEdit('${parentId}', '${childId}')">Save</button>
  `;
  
  panel.classList.add('open');
}

async function saveLinkEdit(parentId, childId) {
  const fastener = document.getElementById('editLinkFastener').value.trim();
  const fastener_qty = parseInt(document.getElementById('editLinkQty').value) || 1;
  
  try {
    const { error } = await db.from('logi_links').update({
      fastener: fastener || null,
      fastener_qty
    }).eq('parent_id', parentId).eq('child_id', childId);
    
    if (error) throw error;
    
    closeSidePanel();
    showToast('Connection updated', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error updating link:', e);
    showToast('Failed to update: ' + e.message, 'error');
  }
}

function confirmDeleteLink(parentId, childId) {
  hideContextMenu();
  
  const parent = nodes.find(n => n.id === parentId);
  const child = nodes.find(n => n.id === childId);
  
  showModal(
    'Delete Connection',
    `<p>Remove connection between "<strong>${escapeHtml(child?.name || 'Child')}</strong>" and "<strong>${escapeHtml(parent?.name || 'Parent')}</strong>"?</p>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Delete', class: 'btn-danger', action: () => deleteLink(parentId, childId) }
    ]
  );
}

async function deleteLink(parentId, childId) {
  try {
    const { error } = await db.from('logi_links').delete()
      .eq('parent_id', parentId)
      .eq('child_id', childId);
    
    if (error) throw error;
    
    hideModal();
    showToast('Connection removed', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error deleting link:', e);
    showToast('Failed to remove: ' + e.message, 'error');
  }
}

// ============================================================
// POSITION MANAGEMENT
// ============================================================
function savePositionState() {
  const state = nodes.map(n => ({ id: n.id, x: n.x, y: n.y }));
  positionHistory.push(state);
  
  if (positionHistory.length > MAX_UNDO_HISTORY) {
    positionHistory.shift();
  }
  
  document.getElementById('undoBtn').disabled = false;
}

function undoPositions() {
  if (positionHistory.length === 0) return;
  
  const state = positionHistory.pop();
  
  for (const saved of state) {
    const node = nodes.find(n => n.id === saved.id);
    if (node) {
      node.x = saved.x;
      node.y = saved.y;
      if (lockedNodes.has(node.id)) {
        node.fx = saved.x;
        node.fy = saved.y;
      }
    }
  }
  
  updatePositions();
  
  if (positionHistory.length === 0) {
    document.getElementById('undoBtn').disabled = true;
  }
  
  showToast('Position undone', 'success');
}

async function saveAllPositions() {
  setStatus('Saving positions...', 'loading');
  
  try {
    let savedCount = 0;
    let lockedCount = 0;
    
    for (const n of nodes) {
      const isLocked = lockedNodes.has(n.id);
      if (isLocked) lockedCount++;
      
      await db.from('logi_nodes').update({
        x: Math.round(n.x),
        y: Math.round(n.y),
        is_locked: isLocked,
        updated_at: new Date().toISOString()
      }).eq('id', n.id);
      
      savedCount++;
    }
    
    showToast(`Saved ${savedCount} positions (${lockedCount} locked)`, 'success');
    setStatus('');
  } catch (e) {
    console.error('Error saving positions:', e);
    showToast('Failed to save positions', 'error');
    setStatus('Error saving', 'error');
  }
}

function lockAllVisibleNodes() {
  for (const node of nodes) {
    lockedNodes.add(node.id);
    node.fx = node.x;
    node.fy = node.y;
  }
  
  renderGraph();
  showToast(`Locked ${nodes.length} nodes`, 'success');
}

function unlockAllNodes() {
  for (const node of nodes) {
    lockedNodes.delete(node.id);
    node.fx = null;
    node.fy = null;
  }
  
  renderGraph();
  showToast('All nodes unlocked', 'success');
}

function refreshUnlockedNodes() {
  for (const node of nodes) {
    if (!lockedNodes.has(node.id)) {
      node.x = null;
      node.y = null;
      node.fx = null;
      node.fy = null;
    }
  }
  
  renderGraph();
  showToast('Refreshed unlocked positions', 'success');
}

// ============================================================
// UI HELPERS
// ============================================================
function closeSidePanel() {
  document.getElementById('sidePanel').classList.remove('open');
}

function toggleCollapse(nodeId) {
  if (collapsedNodes.has(nodeId)) {
    collapsedNodes.delete(nodeId);
  } else {
    collapsedNodes.add(nodeId);
  }
  renderGraph();
}

function expandAll() {
  collapsedNodes.clear();
  renderGraph();
}

function collapseAll() {
  nodes.forEach(n => {
    if (n.receivesFrom.length > 0) {
      collapsedNodes.add(n.id);
    }
  });
  renderGraph();
}

function toggleLockDropdown() {
  document.getElementById('lockDropdown').classList.toggle('show');
}

function closeLockDropdown() {
  document.getElementById('lockDropdown').classList.remove('show');
}

function toggleExportDropdown() {
  document.getElementById('exportDropdown').classList.toggle('show');
}

// ============================================================
// EXPORT FUNCTIONS
// ============================================================
function downloadPNG() {
  toggleExportDropdown();
  
  const svg = document.getElementById('treeSvg');
  if (!svg) return;
  
  const width = parseInt(svg.getAttribute('width'));
  const height = parseInt(svg.getAttribute('height'));
  
  const svgClone = svg.cloneNode(true);
  
  const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
  styleElement.textContent = `
    .link { fill: none !important; }
    .link-label-bg { fill: white; opacity: 0.95; }
    .link-label { font-size: 8px; font-weight: 600; }
    text { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  `;
  svgClone.insertBefore(styleElement, svgClone.firstChild);
  
  const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  bg.setAttribute('width', width);
  bg.setAttribute('height', height);
  bg.setAttribute('fill', 'white');
  svgClone.insertBefore(bg, svgClone.firstChild);
  
  svgClone.querySelectorAll('.link').forEach(link => link.setAttribute('fill', 'none'));
  
  const svgData = new XMLSerializer().serializeToString(svgClone);
  const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);
  
  const canvas = document.createElement('canvas');
  const scale = 2;
  canvas.width = width * scale;
  canvas.height = height * scale;
  
  const ctx = canvas.getContext('2d');
  ctx.scale(scale, scale);
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, width, height);
  
  const img = new Image();
  img.onload = function() {
    ctx.drawImage(img, 0, 0, width, height);
    URL.revokeObjectURL(url);
    
    const pngUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = pngUrl;
    a.download = (currentAssemblyName || 'assembly').replace(/\s+/g, '_') + '.png';
    a.click();
    
    showToast('PNG downloaded', 'success');
  };
  img.src = url;
}

function downloadSVG() {
  toggleExportDropdown();
  
  const svg = document.getElementById('treeSvg');
  if (!svg) return;
  
  const svgClone = svg.cloneNode(true);
  const width = svg.getAttribute('width');
  const height = svg.getAttribute('height');
  
  const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  bg.setAttribute('width', width);
  bg.setAttribute('height', height);
  bg.setAttribute('fill', 'white');
  svgClone.insertBefore(bg, svgClone.firstChild);
  
  const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
  styleElement.textContent = `
    .link { fill: none !important; }
    text { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  `;
  svgClone.insertBefore(styleElement, bg.nextSibling);
  
  svgClone.querySelectorAll('.link').forEach(link => link.setAttribute('fill', 'none'));
  
  const svgData = '<?xml version="1.0" encoding="UTF-8"?>\n' + 
    new XMLSerializer().serializeToString(svgClone);
  
  const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (currentAssemblyName || 'assembly').replace(/\s+/g, '_') + '.svg';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('SVG downloaded', 'success');
}

// ============================================================
// MODAL
// ============================================================
function showModal(title, body, buttons) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = body;
  
  document.getElementById('modalFooter').innerHTML = buttons.map((b, index) => 
    `<button class="btn ${b.class}" data-action="${index}">${b.label}</button>`
  ).join('');
  
  const footer = document.getElementById('modalFooter');
  buttons.forEach((b, index) => {
    const btn = footer.querySelector(`[data-action="${index}"]`);
    if (btn) {
      btn.addEventListener('click', () => {
        if (typeof b.action === 'function') {
          b.action();
        }
      });
    }
  });
  
  document.getElementById('modalOverlay').classList.add('show');
}

function hideModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function setStatus(message, type = '') {
  const indicator = document.getElementById('statusIndicator');
  indicator.textContent = message;
  indicator.className = 'status-text ' + type;
}

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
}

function truncateText(text, maxLength) {
  if (!text) return '';
  return text.length > maxLength ? text.substring(0, maxLength - 1) + '‚Ä¶' : text;
}

// ============================================================
// EVENT LISTENERS
// ============================================================
function setupEventListeners() {
  // Level filter
  document.getElementById('levelFilter').addEventListener('change', (e) => {
    currentLevelFilter = e.target.value;
    renderGraph();
  });
  
  // Color mode
  document.getElementById('colorMode').addEventListener('change', (e) => {
    currentColorMode = e.target.value;
    renderGraph();
  });
  
  // Layout mode
  document.getElementById('layoutMode').addEventListener('change', (e) => {
    currentLayoutMode = e.target.value;
    if (currentLayoutMode === 'radial') {
      nodes.forEach(n => {
        if (n.level >= 3 && !lockedNodes.has(n.id)) {
          n.x = null;
          n.y = null;
          n.fx = null;
          n.fy = null;
        }
      });
    }
    renderGraph();
  });
  
  // Click outside to close menus
  document.addEventListener('click', (e) => {
    if (!e.target.matches('.dropdown-btn')) {
      document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
    }
    if (e.target.isConnected && !e.target.closest('.context-menu') && !e.target.closest('.node') && !e.target.closest('.link')) {
      hideContextMenu();
    }
  });
  
  // Shift key tracking
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Shift') shiftKeyPressed = true;
  });
  
  document.addEventListener('keyup', (e) => {
    if (e.key === 'Shift') {
      shiftKeyPressed = false;
      d3.selectAll('.node').classed('child-highlight', false).classed('dragging-children', false);
    }
  });
  
  // Escape to close panel/modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeSidePanel();
      hideContextMenu();
      hideModal();
    }
  });
  
  // Right-click on empty tree area to add root node
  document.getElementById('treeSvg').addEventListener('contextmenu', (e) => {
    if (!isAdmin) return;
    if (e.target.tagName === 'svg' || e.target.closest('.main') === e.target.closest('g')) {
      if (!e.target.closest('.node') && !e.target.closest('.link-group')) {
        e.preventDefault();
        showAddRootNodeMenu(e);
      }
    }
  });
  
  // Click on SVG to clear selection
  document.getElementById('treeSvg').addEventListener('click', (e) => {
    if (e.target.tagName === 'svg') {
      clearSelection();
    }
  });
}

function showAddRootNodeMenu(event) {
  const menu = document.getElementById('contextMenu');
  
  menu.innerHTML = `
    <div class="context-menu-item" onclick="addRootNode(${event.clientX}, ${event.clientY})">
      <span class="context-menu-icon">‚ûï</span> Add Root Node
    </div>
  `;
  
  positionContextMenu(menu, event.clientX, event.clientY);
  menu.classList.add('show');
}

async function addRootNode(clickX, clickY) {
  hideContextMenu();
  
  if (!isAdmin || !currentAssemblyId) return;
  
  // Convert click coordinates to SVG coordinates
  const container = document.getElementById('treeContainer');
  const svgRect = document.getElementById('treeSvg').getBoundingClientRect();
  const x = clickX - svgRect.left + container.scrollLeft;
  const y = clickY - svgRect.top + container.scrollTop;
  
  showModal(
    'Add Root Node',
    `<div class="form-group">
      <label class="form-label">Node Name</label>
      <input type="text" class="form-input" id="newRootName" placeholder="Enter node name">
    </div>
    <div class="form-group">
      <label class="form-label">Level</label>
      <select class="form-select" id="newRootLevel">
        <option value="1">Level 1 (Root)</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
      </select>
    </div>`,
    [
      { label: 'Cancel', class: 'btn-secondary', action: hideModal },
      { label: 'Add', class: 'btn-primary', action: () => saveRootNode(x, y) }
    ]
  );
  
  setTimeout(() => document.getElementById('newRootName')?.focus(), 100);
}

async function saveRootNode(x, y) {
  const name = document.getElementById('newRootName').value.trim();
  const level = parseInt(document.getElementById('newRootLevel').value) || 1;
  
  if (!name) {
    showToast('Name is required', 'error');
    return;
  }
  
  try {
    const { error } = await db.from('logi_nodes').insert({
      assembly_id: currentAssemblyId,
      name,
      level,
      status: 'NOT_STARTED',
      x,
      y
    });
    
    if (error) throw error;
    
    hideModal();
    showToast('Node added', 'success');
    await loadAssemblyData(currentAssemblyId);
  } catch (e) {
    console.error('Error adding root node:', e);
    showToast('Failed to add node: ' + e.message, 'error');
  }
}

// ============================================================
// INITIALIZE
// ============================================================
init();
</script>
</body>
</html>
