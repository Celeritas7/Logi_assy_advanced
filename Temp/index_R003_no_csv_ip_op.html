<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logi Assembly Tree v28</title>
  
  <!-- External Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- ============================================ -->
<!-- HEADER -->
<!-- ============================================ -->
<div class="header">
  <h1>âš™ï¸ Logi Assembly v28</h1>
  
  <!-- Back button -->
  <button class="header-btn back-btn" id="backBtn" style="display:none;" onclick="navigateBack()">â† Back</button>
  
  <!-- Breadcrumb -->
  <div id="breadcrumb" class="control-group" style="display:none;">
    <span id="breadcrumbText" style="font-size:12px;color:#8892b0;"></span>
  </div>
  
  <!-- Tree controls wrapper -->
  <div id="treeControlsWrapper" style="display:none;">
    <div class="control-group">
      <label>Assembly:</label>
      <select id="assemblySelect">
        <option value="">Loading...</option>
      </select>
      <button class="header-btn admin-only" style="padding:4px 8px;margin-left:4px;" onclick="createNewAssemblyInTree()" title="New Assembly">â•</button>
      <button class="header-btn admin-only" style="padding:4px 8px;background:#f39c12;" onclick="renameAssembly()" title="Rename">âœï¸</button>
      <button class="header-btn admin-only" style="padding:4px 8px;background:#9b59b6;" onclick="duplicateAssembly()" title="Duplicate">ğŸ“‹</button>
      <button class="header-btn admin-only" style="padding:4px 8px;background:#e74c3c;" onclick="confirmDeleteAssembly()" title="Delete">ğŸ—‘ï¸</button>
    </div>
  </div>
  
  <!-- Tree-specific controls -->
  <div id="treeControls" style="display:none;">
    <div class="control-group">
      <label>Level:</label>
      <select id="levelFilter">
        <option value="all">All</option>
        <option value="1">â‰¤L1</option>
        <option value="2">â‰¤L2</option>
        <option value="3">â‰¤L3</option>
        <option value="4">â‰¤L4</option>
        <option value="5">â‰¤L5</option>
        <option value="6">â‰¤L6</option>
        <option value="7">â‰¤L7</option>
        <option value="8">â‰¤L8</option>
      </select>
    </div>
    
    <div class="control-group">
      <label>Color:</label>
      <select id="colorMode">
        <option value="level">Level</option>
        <option value="group">Group</option>
        <option value="status">Status</option>
      </select>
    </div>
    
    <!-- Admin-only controls -->
    <div class="control-group admin-only" id="layoutControl">
      <label>Layout:</label>
      <select id="layoutMode">
        <option value="force">Force</option>
        <option value="radial">Radial (L3+)</option>
      </select>
    </div>
    
    <button class="header-btn admin-only" id="refreshBtn" onclick="refreshUnlockedNodes()">ğŸ”„</button>
    <button class="header-btn admin-only" id="expandBtn" onclick="expandAll()">â•</button>
    <button class="header-btn admin-only" id="collapseBtn" onclick="collapseAll()">â–</button>
    <button class="header-btn undo-btn admin-only" id="undoBtn" onclick="undoPositions()" disabled>â†©ï¸ Undo</button>
    
    <div class="dropdown admin-only">
      <button class="header-btn dropdown-btn" style="background:#9b59b6;" onclick="toggleLockDropdown()">ğŸ”’ Lock â–¼</button>
      <div class="dropdown-content" id="lockDropdown">
        <a href="#" onclick="lockAllVisibleNodes(); closeLockDropdown(); return false;">ğŸ”’ Lock All Visible</a>
        <a href="#" onclick="unlockAllNodes(); closeLockDropdown(); return false;">ğŸ”“ Unlock All</a>
      </div>
    </div>
    
    <button class="header-btn save-btn admin-only" id="saveBtn" onclick="saveAllPositions()">ğŸ’¾ Save</button>
    
    <div class="dropdown">
      <button class="header-btn dropdown-btn" onclick="toggleExportDropdown()">ğŸ“¤ Export â–¼</button>
      <div class="dropdown-content" id="exportDropdown">
        <a href="#" onclick="downloadPNG(); return false;">ğŸ“· Download PNG</a>
        <a href="#" onclick="downloadSVG(); return false;">ğŸ“ Download SVG</a>
      </div>
    </div>
  </div>
  
  <span id="statusIndicator" class="status-text"></span>
  
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
    <div id="dbIndicator" class="db-indicator">
      <span class="db-dot"></span>
      <span>Supabase</span>
    </div>
    
    <!-- Login/User area -->
    <div id="loginArea">
      <button class="header-btn login-btn" id="loginBtn" onclick="handleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:14px;height:14px;"> Sign In
      </button>
    </div>
    <div id="userBadge" class="user-badge" style="display:none;">
      <span id="userName"></span>
      <button class="header-btn" style="padding:2px 6px;font-size:9px;" onclick="handleLogout()">âœ•</button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- HOME PAGE - PROJECTS -->
<!-- ============================================ -->
<div class="home-page show" id="homePage">
  <div class="home-header">
    <h2>ğŸ“ My Projects</h2>
    <p>Select a project to view its assemblies</p>
  </div>
  <div class="projects-grid" id="projectsGrid">
    <!-- Project cards will be rendered here -->
  </div>
</div>

<!-- ============================================ -->
<!-- ASSEMBLIES PAGE -->
<!-- ============================================ -->
<div class="assemblies-page" id="assembliesPage">
  <div class="assemblies-header" id="assembliesHeader">
    <span class="project-icon" id="currentProjectIcon">ğŸ“</span>
    <div class="assemblies-header-info">
      <h2 id="currentProjectName">Project Name</h2>
      <p id="currentProjectDesc">Project description</p>
    </div>
  </div>
  <div class="assemblies-grid" id="assembliesGrid">
    <!-- Assembly cards will be rendered here -->
  </div>
</div>

<!-- ============================================ -->
<!-- TREE VIEW PAGE -->
<!-- ============================================ -->
<div id="treePage" style="display:none;">

  <!-- Legend -->
  <div class="legend">
    <div class="legend-section">
      <span class="legend-title">Levels:</span>
      <div class="legend-item"><div class="legend-color" style="background:#a5d6a7;"></div>L1</div>
      <div class="legend-item"><div class="legend-color" style="background:#e1bee7;"></div>L2</div>
      <div class="legend-item"><div class="legend-color" style="background:#b3e5fc;"></div>L3</div>
      <div class="legend-item"><div class="legend-color" style="background:#c8e6c9;"></div>L4</div>
      <div class="legend-item"><div class="legend-color" style="background:#fff9c4;"></div>L5</div>
      <div class="legend-item"><div class="legend-color" style="background:#ffe0b2;"></div>L6</div>
      <div class="legend-item"><div class="legend-color" style="background:#ffcdd2;"></div>L7</div>
      <div class="legend-item"><div class="legend-color" style="background:#e8e8e8;"></div>L8+</div>
    </div>
    
    <div class="legend-divider"></div>
    
    <div class="legend-section">
      <span class="legend-title">Status:</span>
      <div class="legend-item"><div class="legend-color" style="background:#27ae60;"></div>Done</div>
      <div class="legend-item"><div class="legend-color" style="background:#f1c40f;"></div>WIP</div>
      <div class="legend-item"><div class="legend-color" style="background:#e74c3c;"></div>Blocked</div>
      <div class="legend-item"><div class="legend-color" style="background:#9b59b6; border-style:dashed;"></div>Orphan</div>
    </div>
    
    <div class="legend-divider"></div>
    
    <div class="legend-section admin-only" id="legendTips">
      <span style="color:#666; font-size:9px;">ğŸ’¡ Shift+Drag = move with children | Drag orphan = reconnect | ğŸ”’ = locked position</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="tree-container" id="treeContainer">
      <svg id="treeSvg"></svg>
      
      <!-- Zoom/Fit Controls -->
      <div class="zoom-controls">
        <button onclick="zoomIn()" title="Zoom In">+</button>
        <button onclick="zoomOut()" title="Zoom Out">âˆ’</button>
        <button onclick="fitToScreen()" title="Fit to Screen">âŠ¡</button>
        <button onclick="resetView()" title="Reset View">â†º</button>
      </div>
      
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
      </div>
    </div>
    
    <!-- Side Panel for editing -->
    <div class="side-panel" id="sidePanel">
      <div class="side-panel-header">
        <span class="side-panel-title" id="panelTitle">Edit Node</span>
        <button class="side-panel-close" onclick="closeSidePanel()">Ã—</button>
      </div>
      <div class="side-panel-content" id="panelContent">
        <!-- Dynamic content -->
      </div>
      <div class="side-panel-footer" id="panelFooter">
        <!-- Dynamic buttons -->
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <!-- Dynamic content -->
  </div>

</div><!-- End treePage -->

<!-- Modal for confirmations -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Confirm</div>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer" id="modalFooter">
      <!-- Dynamic buttons -->
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Chatbot FAB Button -->
<button class="chat-fab" onclick="toggleChatPanel()" title="Assembly Assistant">
  ğŸ¤–
</button>

<!-- Chatbot Panel -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <h3>ğŸ¤– Assembly Assistant</h3>
    <button class="chat-close" onclick="closeChatPanel()">Ã—</button>
  </div>
  
  <div class="chat-quick-actions">
    <button class="quick-btn" onclick="quickStatus()">ğŸ“Š Status</button>
    <button class="quick-btn" onclick="quickBlocked()">ğŸš« Blocked</button>
    <button class="quick-btn" onclick="quickParallel()">ğŸš€ Parallel Work</button>
    <button class="quick-btn" onclick="quickProgress()">ğŸ“ˆ Progress</button>
  </div>
  
  <div class="chat-messages" id="chatMessages">
    <div class="chat-message assistant">
      <div class="chat-bubble assistant">
        ğŸ‘‹ Hi! I'm your Assembly Assistant. I can help you with:
        <br><br>
        â€¢ Assembly status & progress
        <br>â€¢ Finding blocked items
        <br>â€¢ Suggesting parallel work
        <br>â€¢ Critical path analysis
        <br><br>
        Try the quick buttons above or ask me anything!
      </div>
    </div>
  </div>
  
  <div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="Ask about your assembly..." 
           onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="chat-send" onclick="sendMessage()">â¤</button>
  </div>
</div>

<!-- Main Application Module -->
<script type="module" src="js/app.js"></script>

</body>
</html>
